%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#E8F4F8','primaryTextColor':'#1a1a1a','primaryBorderColor':'#0066cc','lineColor':'#333','secondaryColor':'#FFF4E6','fontSize':'13px'}}}%%

graph LR
    subgraph stack1["üì± NODO IoT (ESP32 + nRF52840)"]
        direction TB
        A7[DLMS/COSEM<br/>IEC 62056]
        A6[CoAP<br/>RFC 7252<br/>22B overhead]
        A5[LwM2M<br/>OMA SpecWorks]
        A4[UDP<br/>Port 5683]
        A3[IPv6<br/>IPHC Compression<br/>48B ‚Üí 4.2B]
        A2[6LoWPAN<br/>RFC 6282<br/>Fragmentation]
        A1[Thread 1.3.0<br/>IEEE 802.15.4<br/>2.4 GHz<br/>AES-128-CCM]
    end

    subgraph stack2["üåê OTBR (Border Router)"]
        direction TB
        B7[CoAP/UDP]
        B6[IPv6 Native<br/>No Compression]
        B5[Ethernet<br/>IEEE 802.3]
        B4[Thread RCP<br/>nRF52840]
    end

    subgraph stack3["üöÄ GATEWAY (Raspberry Pi)"]
        direction TB
        C8[MQTT<br/>Port 8883]
        C7[TLS 1.3<br/>mTLS<br/>X.509 Certs]
        C6[TCP<br/>Port 8883]
        C5[IPv4/IPv6<br/>Dual Stack]
        C4[Wi-Fi HaLow<br/>802.11ah<br/>902-928 MHz<br/>WPA3-SAE]
    end

    subgraph stack4["‚òÅÔ∏è THINGSBOARD CLOUD"]
        direction TB
        D6[ThingsBoard API<br/>REST + WebSocket]
        D5[MQTT Broker<br/>Port 8883]
        D4[TLS 1.3<br/>Server Auth]
        D3[TCP]
        D2[IPv4]
        D1[Ethernet<br/>Cloud Infrastructure]
    end

    %% Conexiones
    A1 -.->|Thread Mesh<br/>Multi-hop| B4
    B5 -.->|Ethernet| C4
    C4 -.->|HaLow Uplink<br/>>1 km| D1

    %% Estilos
    classDef iot fill:#E6F3FF,stroke:#0066CC,stroke-width:2px,color:#000
    classDef otbr fill:#FFF4E6,stroke:#FF8C00,stroke-width:2px,color:#000
    classDef gateway fill:#FFE6E6,stroke:#CC0000,stroke-width:2px,color:#000
    classDef cloud fill:#E8F5E8,stroke:#2E7D32,stroke-width:2px,color:#000

    class A1,A2,A3,A4,A5,A6,A7 iot
    class B4,B5,B6,B7 otbr
    class C4,C5,C6,C7,C8 gateway
    class D1,D2,D3,D4,D5,D6 cloud
