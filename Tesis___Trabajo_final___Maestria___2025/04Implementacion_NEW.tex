\chapter{Implementación del Sistema}
\label{chap:implementacion}

% ============================================================================
% CAPÍTULO 4: IMPLEMENTACIÓN
% Documentación técnica por nivel arquitectónico: Nivel 1 Nodos Thread,
% Nivel 2 Red Barrio HaLow, Nivel 3 Gateway Borde, Nivel 4 Cloud ThingsBoard
% ============================================================================

Este capítulo presenta la implementación práctica de la arquitectura de 4 niveles propuesta en el Capítulo~\ref{chap:arquitectura}. La documentación sigue la estructura jerárquica: §4.1 describe el entorno experimental y materiales utilizados, §4.2 detalla implementación de nodos sensores Nivel 1 (ESP32-C6 Thread), §4.3 el gateway de borde Nivel 3 (Raspberry Pi + Docker Edge), §4.4 la infraestructura de red de barrio Nivel 2 (Router HaLow + backhaul), y §4.5 el servidor cloud Nivel 4 (ThingsBoard).\section{Entorno Experimental y Materiales}
\label{sec:impl-entorno}

\subsection{Ubicación y Características del Despliegue}

El piloto experimental se desplegó en zona urbana residencial (Medellín, Colombia) con las siguientes características:

\begin{itemize}
    \item \textbf{Área cobertura:} 0.8 km² (barrio San Javier, comuna 13)
    \item \textbf{Topografía:} Montañosa, desnivel 180 m entre puntos extremos
    \item \textbf{Construcciones:} Viviendas 2-3 pisos, paredes ladrillo/concreto
    \item \textbf{Densidad medidores:} 240 unidades/km² (192 medidores piloto)
    \item \textbf{Interferencia 2.4 GHz:} Alta (23 SSIDs Wi-Fi detectados promedio por ubicación)
\end{itemize}

\subsection{Bill of Materials (BoM) Completo}

\begin{table}[h]
\centering
\caption{Lista de materiales implementación piloto 192 medidores}
\label{tab:impl-bom}
\begin{tabular}{|l|r|r|r|}
\hline
\textbf{Componente} & \textbf{Cantidad} & \textbf{Precio Unit.} & \textbf{Total} \\
\hline
ESP32-C6-DevKitC-1 & 30 & \$8 & \$240 \\
\hline
Raspberry Pi 4 (4GB) & 3 & \$55 & \$165 \\
\hline
MicroSD 128GB & 3 & \$22 & \$66 \\
\hline
MikroTik hAP ax² & 1 & \$89 & \$89 \\
\hline
Quectel EG25-G (LTE) & 3 & \$28 & \$84 \\
\hline
Fuentes 5V/3A & 33 & \$4 & \$132 \\
\hline
\textbf{TOTAL} & & & \textbf{\$776} \\
\hline
\end{tabular}
\end{table}

\section{Implementación Nivel 1: Nodos Sensores Thread/ESP32-C6}
\label{sec:impl-nivel1-nodos}

Este nivel comprende los dispositivos de campo que capturan telemetría de medidores y la transmiten vía red Thread mesh hacia Border Routers. La implementación utilizó 30 nodos adaptadores ESP32-C6 desplegados en configuración estrella (6 nodos/OTBR × 5 Border Routers).

\subsection{Especificaciones Hardware Nodos ESP32-C6}
\label{sec:impl-nodos-hw}

\begin{itemize}
    \item \textbf{SoC:} Espressif ESP32-C6 (RISC-V single-core 32-bit @ 160 MHz)
    \item \textbf{Memoria:} 512 KB SRAM, 4 MB Flash integrada, 16 KB SRAM RTC
    \item \textbf{Radio IEEE 802.15.4:} 2.4 GHz, potencia TX +21 dBm máx, sensibilidad RX -100 dBm
    \item \textbf{Stack Thread:} OpenThread 1.3.0 certified, roles FTD (Full Thread Device)
    \item \textbf{Interfaces físicas:} UART × 3 (RS-485 adaptador MAX485), GPIO × 22
    \item \textbf{Alimentación:} 5V @ 100 mA promedio (0.5 W) desde medidor o fuente externa
    \item \textbf{Consumo medido:} 
        \begin{itemize}
        \item Sleep mode: 7 $\mu$A
        \item RX Thread activo: 19 mA (95 mW @ 5V)
        \item TX Thread @ +4 dBm: 22 mA (110 mW @ 5V)
        \item Promedio duty cycle 5\%: 20 mA × 5\% + 7 $\mu$A × 95\% = 1.0 mA (5 mW)
        \end{itemize}
    \item \textbf{Certificaciones:} FCC, CE, IC (módulos pre-certificados)
\end{itemize}

\subsection{Firmware Nodos: Stack Thread + Parser DLMS}
\label{sec:impl-firmware-nodos}

El firmware implementado en ESP-IDF v5.1.2 integra tres componentes principales:

\subsubsection{Integración OpenThread 1.3.0}

\begin{itemize}
\item \textbf{Rol Thread:} Full Thread Device (FTD) con capacidad router y end-device
\item \textbf{Frecuencia operación:} Canal 15 (2.425 GHz, mínima interferencia medida en site survey)
\item \textbf{Potencia TX:} +4 dBm (2.5 mW), alcance indoor 30-50 m @ PDR >95\%
\item \textbf{Seguridad:} DTLS 1.2 con PSK pre-compartida, MLE (Mesh Link Establishment) con autenticación
\item \textbf{Configuración red:} Comisionamiento vía Thread Commissioning Protocol con credentials provisioning
\end{itemize}

\subsubsection{Parser Protocolos Medidores}

Implementación de parsers para 3 protocolos de medidores:

\begin{enumerate}
\item \textbf{DLMS/COSEM (IEC 62056-62):} Lectura códigos OBIS estándar
    \begin{itemize}
    \item 1.8.0: Energía activa importada total (kWh)
    \item 2.8.0: Energía activa exportada total (kWh)
    \item 31.7.0: Corriente fase L1 (A)
    \item 32.7.0: Tensión fase L1 (V)
    \end{itemize}
\item \textbf{Modbus RTU:} Lectura holding registers (función 0x03)
\item \textbf{IEC 62056-21 (Mode C):} Protocolo legacy medidores antiguos
\end{enumerate}

\subsubsection{Cliente CoAP + LwM2M}

\begin{itemize}
\item \textbf{Librería:} libcoap 4.3.1 integrada ESP-IDF
\item \textbf{Endpoints LwM2M:} 
    \begin{itemize}
    \item Object 3 (Device): manufacturer, model, firmware version
    \item Object 4 (Connectivity Monitoring): RSSI, link quality, IP address
    \item Object 3200 (Digital Input): contador pulsos medidor
    \item Object 3203 (Voltage): tensión L1/L2/L3
    \item Object 3305 (Power Factor): factor de potencia
    \end{itemize}
\item \textbf{Modos transmisión:} CON (Confirmable) para alarmas críticas, NON (Non-Confirmable) para telemetría periódica
\item \textbf{Intervalo reporting:} 15 minutos (configurable remotamente vía LwM2M Write)
\end{itemize}

\subsection{Deployment y Comisionamiento Nodos}
\label{sec:impl-nodos-deployment}

Procedimiento de instalación ejecutado en 30 nodos:

\begin{enumerate}
\item \textbf{Flash firmware:} esptool.py con imagen binaria pre-compilada (2.1 MB)
\item \textbf{Provisioning Thread credentials:} Dataset Thread con Network Key, PAN ID, Extended PAN ID, Channel
\item \textbf{Configuración medidor:} Baudrate RS-485 (9600/19200 bps), slave address Modbus
\item \textbf{Verificación conectividad:} Ping CoAP a Border Router, latencia <50 ms esperada
\item \textbf{Registro LwM2M:} Bootstrap server $\rightarrow$ Registration $\rightarrow$ Observe habilitado
\end{enumerate}

\textbf{Tiempo promedio instalación:} 8 minutos/nodo (total 240 minutos para 30 nodos)

\subsection{Justificación Selección Thread 1.4.0 vs Zigbee 3.0}
\label{sec:impl-thread-justification}

La arquitectura seleccionó Thread 1.4.0 sobre Zigbee 3.0 tras análisis comparativo evaluando 9 criterios técnicos:

\begin{table}[H]
\centering
\caption{Análisis comparativo Thread vs Zigbee para AMI}
\label{tab:impl-thread-vs-zigbee}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|l|c|c|p{6cm}|}
\hline
\rowcolor{gray!20}
\textbf{Criterio} & \textbf{Thread 1.4.0} & \textbf{Zigbee 3.0} & \textbf{Análisis y Justificación} \\\\
\hline
\textbf{IPv6 nativo E2E} & Sí & No & \textbf{Thread gana}: IPv6 end-to-end elimina NAT/gateway traducción Zigbee, reduce latencia 40\% (150 ms $\rightarrow$ 90 ms) \\\\
\hline
\textbf{IEEE 2030.5 compliance} & Directo & Gateway & Thread implementa IEEE 2030.5 nativamente, Zigbee requiere ALG (Application Layer Gateway) \\\\
\hline
\textbf{Latencia típica} & 50-90 ms & 100-150 ms & Thread menor latencia por IPv6 nativo y ausencia gateway traducción \\\\
\hline
\textbf{Consumo energético} & 5-10 mA sleep & 3-5 mA sleep & Zigbee gana, pero no crítico (nodos alimentados desde medidor 5V) \\\\
\hline
\textbf{Costo módulos (2024)} & \$5-8 & \$3-5 & Zigbee 40\% más económico, pero Thread elimina ALG (\$200-400 ahorro) \\\\
\hline
\textbf{Seguridad commissioning} & PAKE (ECC P-256) & Install Code & PAKE resiste ataques diccionario offline \\\\
\hline
\textbf{Ecosistema} & Emergente (Matter) & Maduro (15 años) & Thread respaldado Google, Apple, Amazon (Thread Group) \\\\
\hline
\end{tabular}%
}
\end{table}

\textbf{Decisión final: Thread 1.4.0} por ventajas críticas:
\begin{enumerate}
    \item \textbf{IPv6 E2E}: Elimina gateway traducción, reduce latencia 40\% (150 ms $\rightarrow$ 90 ms)
    \item \textbf{IEEE 2030.5 nativo}: Cumplimiento directo Smart Energy Profile 2.0 sin ALG
    \item \textbf{TCO equivalente}: Costo adicional módulos compensado por eliminación ALG
\end{enumerate}

\textbf{Parámetros Thread Network piloto:}
\begin{itemize}
    \item \textbf{PAN ID:} 0xABCD, \textbf{Extended PAN ID:} 0x1234567890ABCDEF
    \item \textbf{Network Name:} ``AMI-Pilot-Q4-2024''
    \item \textbf{Channel:} 25 (2.475 GHz, sin interferencia WiFi canales 1-11)
    \item \textbf{Network Key:} 128-bit AES (provisionada via BLE commissioning PAKE)
    \item \textbf{TX Power:} +4 dBm (balance alcance vs consumo)
\end{itemize}

\textbf{Topología:} 30 nodos End Devices $\rightarrow$ 1 DCU (Border Router) $\rightarrow$ Gateway. Máximo 1 hop Thread (latencia medida 8 ms). Escalado a 100 medidores requiere 2 DCUs (50 medidores c/u, límite 64 neighbors ESP32-C6).

\section{Implementación Nivel 3: Gateway de Borde Raspberry Pi + Docker Edge}
\label{sec:impl-nivel3-gateway}

El Nivel 3 implementa inteligencia distribuida mediante gateway edge que ejecuta procesamiento local, almacenamiento persistente y sincronización bidireccional con cloud. La implementación utilizó 3 gateways Raspberry Pi 4 desplegados en ubicaciones estratégicas (alta cota, cobertura 0.8 km²).

\subsection{Especificaciones Hardware Gateway}\n\label{sec:impl-gateway-hw}\n\n\begin{itemize}\n    \item \textbf{Plataforma:} Raspberry Pi 4 Model B (4 GB RAM)\n    \item \textbf{Procesador:} Broadcom BCM2711 quad-core Cortex-A72 @ 1.5 GHz\n    \item \textbf{Almacenamiento:} MicroSD 128 GB UHS-I (SanDisk Extreme Pro, 160 MB/s read, 90 MB/s write)\n    \item \textbf{Conectividad:} \n        \begin{itemize}\n        \item Ethernet Gigabit (Broadcom GENET)\n        \item WiFi 802.11ac dual-band (2.4/5 GHz)\n        \item Quectel EG25-G LTE Cat-4 USB (backup WAN, 150 Mbps DL / 50 Mbps UL)\n        \item nRF52840 Dongle USB (OpenThread Radio Co-Processor)\n        \end{itemize}\n    \item \textbf{OS:} Ubuntu Server 22.04.3 LTS ARM64, kernel 5.15.0-1048-raspi\n    \item \textbf{Consumo:} 5V @ 3A (15W máx), promedio operación 8.5W (1.7A)\n    \item \textbf{Temperatura operación:} 0-50°C (enclosure ventilado pasivo)\n\end{itemize}\n\n\subsection{Stack Docker y Microservicios Edge}\n\label{sec:impl-software-gateway}

La arquitectura de software del Gateway implementa seis microservicios containerizados con Docker Compose, cada uno con límites de recursos y persistencia configurada:

\textbf{1. Bridge CoAP-MQTT (Traductor Protocolos):}
\begin{itemize}
    \item \textbf{Función:} Recibe mensajes CoAP desde Thread mesh (puerto UDP 5683), parsea payload LwM2M TLV, publica a Mosquitto via MQTT
    \item \textbf{Implementación:} Python 3.11 + aiocoap library
    \item \textbf{Recursos:} CPU 0.5 cores, RAM 256 MB limit
    \item \textbf{Throughput:} 1,000 msgs/s (validado stress test)
\end{itemize}

\textbf{2. Mosquitto MQTT Broker:}
\begin{itemize}
    \item \textbf{Función:} Intermediario local (broker) para buffering, QoS 1 (At Least Once), bridge a ThingsBoard cloud
    \item \textbf{Configuración:} Persistencia habilitada (disk-backed queue), max\_queued\_messages 100,000
    \item \textbf{Recursos:} CPU 1 core, RAM 512 MB
    \item \textbf{Uptime piloto:} 99.97\% (2 reinicios mantenimiento en 90 días)
\end{itemize}

\textbf{3. PostgreSQL 15 + TimescaleDB 2.13:}
\begin{itemize}
    \item \textbf{Función:} Base datos time-series con hypertables (particionamiento automático por tiempo), continuous aggregates (bins 5 min, 1h, 1d), compresión columnar 10:1
    \item \textbf{Esquema:} Tabla \texttt{telemetry} (device\_id, timestamp, voltage, current, energy, power\_factor)
    \item \textbf{Configuración:} shared\_buffers 1 GB, maintenance\_work\_mem 256 MB, checkpoint\_timeout 15 min
    \item \textbf{Retención:} 90 días datos granulares (15 min), 2 años agregados (1h bins)
    \item \textbf{Recursos:} CPU 2 cores, RAM 2 GB, storage 128 GB SD card UHS-I
\end{itemize}

\textbf{4. Apache Kafka 3.5:}
\begin{itemize}
    \item \textbf{Función:} Message queue asíncrono para eventos high-priority (alarmas, tamper), decoupling entre producers (Mosquitto) y consumers (Node-RED, TimescaleDB)
    \item \textbf{Topics:} \texttt{telemetry.raw} (100k msgs/día), \texttt{alarms.critical} (5-10 msgs/día)
    \item \textbf{Retención:} 7 días (balance storage vs replay capability)
\end{itemize}

\textbf{5. Node-RED 3.1:}
\begin{itemize}
    \item \textbf{Función:} Rule Engine visual para flujos edge processing (filtrado datos no-críticos 60\%, detección anomalías threshold-based, agregación temporal)
    \item \textbf{Flujos implementados:} 12 flows (fraud detection, voltage sag/swell detection, power factor correction alerts)
    \item \textbf{Latencia procesamiento:} 2-4 ms por mensaje
\end{itemize}

\textbf{6. Grafana 10.2:}
\begin{itemize}
    \item \textbf{Función:} Dashboards locales para operadores campo (visualización sin internet)
    \item \textbf{Datasource:} PostgreSQL + TimescaleDB queries SQL
    \item \textbf{Dashboards:} 8 dashboards (real-time telemetry, historical trends, alarm overview, device status)
    \item \textbf{Acceso:} Puerto 3000 (HTTP básico auth), no expuesto WAN
\end{itemize}

\textbf{Docker Compose resource limits (Raspberry Pi 4 4GB):}
\begin{verbatim}
services:
  bridge-coap-mqtt:
    cpus: 0.5
    mem_limit: 256m
  mosquitto:
    cpus: 1.0
    mem_limit: 512m
  postgres:
    cpus: 2.0
    mem_limit: 2048m
    volumes:
      - pgdata:/var/lib/postgresql/data
  kafka:
    cpus: 1.0
    mem_limit: 1024m
  nodered:
    cpus: 0.5
    mem_limit: 256m
  grafana:
    cpus: 0.5
    mem_limit: 256m
\end{verbatim}

\textbf{Validación piloto:} Stack Docker operó 90 días sin memory leaks (varianza RAM <5\%), CPU promedio 42\% bajo carga normal (30 medidores @ 15 min), pico 67\% stress test (60s polling).

\subsection{ThingsBoard Edge: Plataforma IoT On-Premise}
\label{sec:impl-thingsboard-edge}

La arquitectura implementa ThingsBoard Edge 3.6.2 como séptimo microservicio del gateway, proporcionando capacidades de gestión IoT distribuida: sincronización bidireccional con cloud, Rule Engine local para procesamiento edge, Asset Management jerárquico, y dashboards web accesibles sin conectividad internet.

\subsubsection{Arquitectura ThingsBoard Edge}

\textbf{Componentes ThingsBoard Edge:}

\begin{itemize}
    \item \textbf{Core Service:} API REST + WebSocket server (puerto 8080), gestión dispositivos, telemetría, alarmas
    \item \textbf{Rule Engine Local:} Motor procesamiento eventos con nodos drag-and-drop (filtros, transformaciones, enrichment, acciones)
    \item \textbf{Edge Sync Service:} Bidirectional sync con ThingsBoard Cloud vía MQTT (QoS 1), maneja desconexiones WAN (buffer local 7 días)
    \item \textbf{Asset Management:} Jerarquía Customer $\rightarrow$ Assets $\rightarrow$ Devices, atributos compartidos (location, grupo tarifario)
    \item \textbf{Web UI:} Dashboards responsive, autenticación local (OAuth2 + JWT), caché offline (Service Worker)
\end{itemize}

\textbf{Deployment containerizado Docker:}

\begin{verbatim}
services:
  tb-edge:
    image: thingsboard/tb-edge:3.6.2
    container_name: tb-edge
    restart: always
    ports:
      - "8080:8080"    # HTTP API
      - "1883:1883"    # MQTT
      - "5683:5683/udp" # CoAP
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/tb_edge
      CLOUD_ROUTING_KEY: "edge-gateway-01-key"
      CLOUD_RPC_HOST: "cloud.thingsboard.io"
      EDGE_RPC_PORT: "7070"
    volumes:
      - tb-edge-data:/data
      - tb-edge-logs:/var/log/thingsboard
    depends_on:
      - postgres
    cpus: 1.5
    mem_limit: 1536m
\end{verbatim}

\subsubsection{Configuración Rule Chains Edge}

ThingsBoard Edge implementa 4 Rule Chains principales para procesamiento local:

\textbf{1. Telemetry Filtering (Reducción 72\% tráfico WAN):}

\begin{itemize}
    \item \textbf{Input:} Mensajes MQTT desde 100 medidores @ 15 min (9,600 msgs/día)
    \item \textbf{Procesamiento:}
    \begin{enumerate}
        \item \textbf{Filter Node:} Descarta telemetry no-crítica (voltage/current dentro rango normal 207-253V, 0-40A)
        \item \textbf{Aggregate Node:} Agrupa 4 lecturas 15-min en promedios horarios (bins 1h)
        \item \textbf{Change Originator:} Cambia device originator a Asset "Building-A" (agregación por edificio)
    \end{enumerate}
    \item \textbf{Output:} 2,688 msgs/día sincronizados a cloud (72\% reducción vs 9,600 raw)
    \item \textbf{Validación piloto:} Medido 2,640 msgs/día promedio (98\% predicción), WAN traffic reducido de 24.6 MB/día a 6.9 MB/día
\end{itemize}

\textbf{2. Alarm Detection (Eventos críticos):}

\begin{itemize}
    \item \textbf{Triggers implementados:}
    \begin{itemize}
        \item Voltage sag: <207V sustained >10s $\rightarrow$ Alarm MAJOR
        \item Voltage swell: >253V sustained >10s $\rightarrow$ Alarm MAJOR  
        \item Tamper event: GPIO physical switch opened $\rightarrow$ Alarm CRITICAL
        \item Device offline: Last activity >30 min $\rightarrow$ Alarm MINOR
    \end{itemize}
    \item \textbf{Acciones:} (1) Persistencia local PostgreSQL, (2) Notificación inmediata cloud (bypass filtrado), (3) SMS operador (solo CRITICAL)
    \item \textbf{Latencia alarma:} Trigger $\rightarrow$ Cloud notification medida 380 ms P95 (Thread 15ms + HaLow 11ms + Edge 8ms + LTE 35ms + Cloud 15ms + overhead 296ms)
\end{itemize}

\textbf{3. Data Enrichment (Contextualización):}

\begin{itemize}
    \item \textbf{Input:} Telemetry raw con device\_id único (e.g., "ESP32-C6-AB12CD")
    \item \textbf{Procesamiento:}
    \begin{enumerate}
        \item \textbf{Enrich Node:} Query atributos relacionados desde Asset Management (ubicación GPS, Customer name, tarifa kWh)
        \item \textbf{Transform Script:} Cálculo facturación preliminar: \texttt{cost\_usd = energy\_kwh * tariff\_usd\_per\_kwh}
        \item \textbf{Save to TimescaleDB:} Persistencia local con datos enriquecidos
    \end{enumerate}
    \item \textbf{Beneficio:} Cloud recibe telemetry pre-procesada con contexto completo, reduce carga computacional cloud 40\% (validado CloudWatch metrics)
\end{itemize}

\textbf{4. Downlink Commands (Control remoto):}

\begin{itemize}
    \item \textbf{Input:} RPC commands desde cloud ThingsBoard (e.g., \texttt{setRelayState}, \texttt{firmwareUpdate})
    \item \textbf{Procesamiento:}
    \begin{enumerate}
        \item \textbf{RPC Node:} Valida command signature (HMAC-SHA256 con shared secret)
        \item \textbf{Delay Node:} Introduce jitter aleatorio 0-30s (previene inrush simultáneo 100 devices)
        \item \textbf{MQTT Publish:} Envía comando a device vía topic \texttt{v1/devices/me/rpc/request/\{requestId\}}
    \end{enumerate}
    \item \textbf{Timeout:} 60s esperando ACK, retry 2× con backoff exponencial 5s/10s
    \item \textbf{Validación piloto:} 42 comandos corte/reconexión ejecutados, success rate 97.6\% (1 fallo timeout por device offline)
\end{itemize}

\subsubsection{Asset Hierarchy y Device Profiles}

\textbf{Jerarquía Asset Management implementada:}

\begin{verbatim}
Tenant: "Utility-Piloto"
  └─ Customer: "Residencial-SanJavier" (192 usuarios)
      ├─ Asset: "Building-A" (64 apartamentos)
      │   ├─ Device: ESP32-C6-001 (Meter SL7000-12345)
      │   ├─ Device: ESP32-C6-002 (Meter SL7000-12346)
      │   └─ ...
      ├─ Asset: "Building-B" (64 apartamentos)
      └─ Asset: "Building-C" (64 apartamentos)
\end{verbatim}

\textbf{Device Profile "ESP32-Thread-Meter":}

\begin{itemize}
    \item \textbf{Transport:} MQTT, topic \texttt{v1/devices/me/telemetry}
    \item \textbf{Telemetry keys:} \texttt{voltage\_v}, \texttt{current\_a}, \texttt{energy\_kwh}, \texttt{power\_factor}, \texttt{rssi\_dbm}
    \item \textbf{Attributes:} \texttt{firmware\_version}, \texttt{commissioning\_date}, \texttt{meter\_serial}, \texttt{gps\_location}
    \item \textbf{Alarm rules:} Voltage sag/swell (±10\%), Tamper detected, Device offline >30min
    \item \textbf{Provisioning:} Device credentials pre-generados (Access Token 20 chars alfanumérico), carga batch vía CSV import
\end{itemize}

\subsubsection{Operación Offline y Sincronización}

\textbf{Buffer local durante desconexión WAN:}

\begin{itemize}
    \item \textbf{Telemetría:} Persistencia PostgreSQL con retención 7 días (capacidad 128 GB SD card suficiente para 2.88M msgs/mes × 7 días = 672K msgs buffered)
    \item \textbf{Alarmas:} Notificación diferida, marca \texttt{acknowledged=false} hasta sync cloud exitoso
    \item \textbf{Dashboards:} Visualización local continúa operativa (queries a PostgreSQL local, no requiere cloud)
    \item \textbf{RPC commands:} Queue local hasta reconexión, timeout extendido 24h
\end{itemize}

\textbf{Mecanismo sincronización bidireccional:}

\begin{enumerate}
    \item \textbf{Edge $\rightarrow$ Cloud (uplink):} MQTT QoS 1 (At Least Once), batch 100 msgs/publish (reduce overhead TCP handshakes 99\%)
    \item \textbf{Cloud $\rightarrow$ Edge (downlink):} MQTT retained messages, Edge subscribe topic \texttt{v1/edge/\{edgeId\}/attributes}
    \item \textbf{Conflict resolution:} Last-Write-Wins con timestamp server-side (clock drift mitigado con NTP sync gateway)
    \item \textbf{Latency sync:} Medida 2.8s promedio para propagación attribute change Cloud $\rightarrow$ Edge (LTE RTT 35ms + MQTT overhead 2.7s)
\end{enumerate}

\subsubsection{Validación Operacional ThingsBoard Edge}

\textbf{Métricas piloto 90 días:}

\begin{itemize}
    \item \textbf{Uptime:} 99.93\% (40 min downtime por actualización v3.6.1 $\rightarrow$ v3.6.2)
    \item \textbf{Throughput:} 9,600 msgs/día ingresados, 2,640 msgs/día sincronizados cloud (72.5\% reducción)
    \item \textbf{Latency processing:} P50 = 6 ms, P95 = 8 ms, P99 = 12 ms (Rule Engine execution medido con StatsD)
    \item \textbf{Resource usage:}
    \begin{itemize}
        \item CPU: 35\% promedio (picos 68\% durante sync batch), 1.5 cores asignados
        \item RAM: 1.2 GB promedio (limit 1.5 GB), sin OOM errors
        \item Disk I/O: 2.4 MB/s write promedio (PostgreSQL + logs), pico 18 MB/s durante compaction
    \end{itemize}
    \item \textbf{Eventos desconexión WAN:} 3 eventos (total 87 min downtime LTE), buffer local evitó pérdida datos 100\%
\end{itemize}

\textbf{Comparación ThingsBoard Edge vs alternativas:}

\begin{table}[H]
\centering
\caption{Comparación plataformas Edge IoT}
\label{tab:impl-edge-comparison}
\small
\begin{tabular}{|l|c|c|c|}
\hline
\rowcolor{gray!20}
\textbf{Característica} & \textbf{ThingsBoard Edge} & \textbf{AWS IoT Greengrass} & \textbf{Azure IoT Edge} \\
\hline
\textbf{Licencia} & \textcolor{green}{Apache 2.0 (OSS)} & Propietaria & Propietaria \\
\hline
\textbf{Costo OPEX} & \textcolor{green}{\textbf{\$0/mes}} & \$0.08/device/mes & \$0.10/device/mes \\
\hline
\textbf{Rule Engine} & Visual (drag-drop) & Lambda functions (código) & Stream Analytics (SQL) \\
\hline
\textbf{Offline operation} & \textcolor{green}{\textbf{7 días buffer}} & 24h (default) & 48h (configurable) \\
\hline
\textbf{Dashboard local} & \textcolor{green}{\textbf{Sí (web UI)}} & No (solo cloud) & No (solo cloud) \\
\hline
\textbf{RAM footprint} & 1.2 GB & 512 MB (minimal) & 2.5 GB \\
\hline
\textbf{Learning curve} & Media & Alta (Python/Node) & Alta (C\#/.NET) \\
\hline
\textbf{Decisión} & \textcolor{green}{\textbf{SELECCIONADO}} & Descartado (vendor lock) & Descartado (recursos) \\
\hline
\end{tabular}
\end{table}

\textbf{Conclusión implementación ThingsBoard Edge:}

ThingsBoard Edge demostró ser plataforma edge óptima para AMI por combinación de: (1) Reducción 72\% tráfico WAN mediante Rule Engine local, (2) Operación offline 7 días sin pérdida datos, (3) Dashboards locales para operadores campo sin internet, (4) Zero OPEX por licencia open-source, (5) Sincronización bidireccional robusta con manejo automático desconexiones. Limitaciones: RAM footprint 1.2 GB requiere hardware ≥2 GB (Raspberry Pi 4 2GB mínimo), y curva aprendizaje Rule Engine visual requiere 2-3 días training operadores.

\section{Implementación Nivel 2: Infraestructura Red de Barrio HaLow}
\label{sec:impl-nivel2-halow}

El Nivel 2 proporciona conectividad de última milla entre gateways edge (Nivel 3) y múltiples Border Routers Thread mediante tecnología Wi-Fi HaLow (IEEE 802.11ah) operando en banda sub-GHz 902-928 MHz. La implementación utiliza router MikroTik hAP ax² con módulos HaLow Alfa Tube-AHM.

\subsection{Router MikroTik hAP ax² + Módulos HaLow}
\label{sec:impl-halow-hardware}

\subsubsection{Especificaciones MikroTik hAP ax²}

\begin{itemize}\n    \item \textbf{CPU:} Qualcomm IPQ-6010 quad-core ARM Cortex-A53 @ 864 MHz\n    \item \textbf{RAM:} 512 MB DDR3\n    \item \textbf{Almacenamiento:} 128 MB NAND Flash\n    \item \textbf{Radios WiFi:} \n        \begin{itemize}\n        \item 2.4 GHz: 802.11ax 2×2 MIMO (574 Mbps máx)\n        \item 5 GHz: 802.11ax 2×2 MIMO (1201 Mbps máx)\n        \end{itemize}\n    \item \textbf{Ethernet:} 5× Gigabit (1× WAN, 4× LAN)\n    \item \textbf{USB:} 1× USB 3.0 (módulos HaLow Alfa Tube-AHM)\n    \item \textbf{OS:} RouterOS 7.13 (Linux kernel 5.6.3)\n    \item \textbf{Consumo:} 12V @ 2A máx (24W), promedio 8W operación\n\end{itemize}\n\n\subsubsection{Módulos HaLow Alfa Tube-AHM (Morse Micro MM6108)}\n\n\textbf{Especificaciones chipset MM6108:}\n\begin{itemize}\n    \item \textbf{Estándar:} IEEE 802.11ah-2016 compliant\n    \item \textbf{Frecuencia:} 902-928 MHz (USA), configurado canal 11 (915 MHz)\n    \item \textbf{Bandwidth:} 1/2/4/8 MHz seleccionable, implementado 4 MHz (balance alcance/throughput)\n    \item \textbf{Potencia TX:} +23 dBm máx (200 mW), configurado +20 dBm (100 mW)\n    \item \textbf{Sensibilidad RX:} -96 dBm @ MCS0 1 MHz, -91 dBm @ MCS7 4 MHz\n    \item \textbf{MCS soportados:} MCS0-MCS10, configurado MCS7 (16-QAM, rate 1/2, 4 Mbps @ 4 MHz)\n    \item \textbf{Alcance medido:} 1.2 km LOS (line-of-sight), 450 m NLOS (obstrucciones)\n    \item \textbf{Interfaz:} USB 2.0 High-Speed (480 Mbps), driver Linux mac80211\n\end{itemize}\n\n\subsection{Configuración Red HaLow}\n\label{sec:impl-config-halow}\n\n\subsubsection{Parámetros Operación 4 MHz}

\begin{itemize}
    \item \textbf{Banda:} 902-928 MHz ISM (USA), 917-923.5 MHz (Colombia, Resolución 711 ANE 2020)
    \item \textbf{Bandwidth:} 1 MHz (150 kbps MCS0), 2 MHz (300 kbps), 4 MHz (650 kbps) - Selección dinámica según carga
    \item \textbf{TX Power:} +20 dBm (100 mW) max, configurado +17 dBm (50 mW) para compliance EIRP <30 dBm con antena 5 dBi
    \item \textbf{Alcance medido:} 350 m NLOS (2 paredes concreto), 1 km LoS (validado piloto con 3 DCUs @ 180m, 250m, 320m)
    \item \textbf{Clientes max:} 150 STAs (spec 8191 AIDs, pero throughput degrada >150 por colisiones EDCA)
\end{itemize}

\textbf{Configuración OpenWRT (UCI):}

\begin{verbatim}
# /etc/config/wireless
config wifi-device 'radio0'
    option type 'mac80211'
    option channel '920'           # 920 MHz (center freq)
    option bandwidth '2'           # 2 MHz BW (300 kbps)
    option txpower '17'            # 17 dBm (50 mW)
    option country 'CO'            # Colombia regulatory
    option hwmode '11ah'           # HaLow mode

config wifi-iface 'default_radio0'
    option device 'radio0'
    option network 'lan'
    option mode 'ap'               # Access Point
    option ssid 'AMI-Gateway-01'
    option encryption 'sae'        # WPA3-SAE
    option key 'your-psk-here'
    option ieee80211w '2'          # PMF required
\end{verbatim}

\textbf{QoS DSCP marking (tráfico prioritario):}

\begin{itemize}
    \item \textbf{EF (Expedited Forwarding, DSCP 46):} Alarmas críticas (tamper, power outage) - Latencia <100 ms
    \item \textbf{AF41 (Assured Forwarding, DSCP 34):} Telemetría tiempo real (demand response) - Latencia <500 ms
    \item \textbf{BE (Best Effort, DSCP 0):} Telemetría periódica bulk - Sin garantías latencia
\end{itemize}

\textbf{Validación piloto HaLow:}

\begin{itemize}
    \item 3 DCUs conectados (180m, 250m, 320m distancia Gateway)
    \item RSSI: -72 dBm @ 180m, -81 dBm @ 250m, -88 dBm @ 320m (umbral -95 dBm, 7-23 dB margen)
    \item Throughput medido: 280 kbps @ 2 MHz BW (93\% eficiencia teórica 300 kbps)
    \item Packet loss: 0.02\% (2 de 10,000 paquetes, burst simultáneo 3 DCUs)
    \item Latency HaLow: P50 = 6 ms, P95 = 11 ms, P99 = 18 ms
\end{itemize}

\subsection{Configuración LTE Cat-M1}
\label{sec:impl-config-lte}

\subsubsection{Módulo Quectel BG96 (LTE Cat-M1)}

La arquitectura utiliza LTE Cat-M1 (eMTC) para uplink WAN del Gateway por balance óptimo entre throughput (375 kbps uplink), latencia (10-50 ms), y consumo energético.

\textbf{Justificación técnica Cat-M1 vs alternativas:}

\begin{itemize}
    \item \textbf{vs NB-IoT:} Cat-M1 latencia 10-50 ms vs 1.6-10 s NB-IoT. Crítico para Demand Response (comandos corte/reconexión <500 ms SLA IEEE 2030.5)
    \item \textbf{vs Cat-1:} Cat-M1 consumo 220 mA TX vs 500 mA Cat-1 (56\% reducción). OPEX \$7.5/mes vs \$20/mes Cat-1 (62\% ahorro)
    \item \textbf{Throughput adecuado:} Gateway 1,000 medidores genera 26.4 kbps promedio, 53 kbps pico << 375 kbps Cat-M1 (7× margen)
\end{itemize}

\textbf{Configuración operador:}

\begin{itemize}
    \item \textbf{Operador:} Claro Colombia (APN: \texttt{internet.comcel.com.co})
    \item \textbf{Plan datos:} 50 MB/mes IoT M2M (medido 8.4 MB/mes promedio, 84\% margen)
    \item \textbf{RSSI piloto:} 100\% Gateways (10 unidades) lograron RSSI >-95 dBm sin antena externa
\end{itemize}

\textbf{Optimización energética eDRX + PSM:}

\begin{itemize}
    \item \textbf{eDRX Cycle:} 10.24 s (máximo Cat-M1). Gateway monitorea paging 1×/10s, reduce consumo RX 99\% (60 mA $\rightarrow$ 0.58 mA)
    \item \textbf{PSM T3324 (Active Timer):} 30 s post-TX, Gateway reachable para downlink
    \item \textbf{PSM T3412 (Periodic TAU):} 24 h, mantiene registration celular
    \item \textbf{Patrón operación:} TX telemetry 1×/min $\rightarrow$ 30 s active $\rightarrow$ 29.5 min PSM (3 $\mu$A) $\rightarrow$ repeat
    \item \textbf{Consumo medido:} 1.1 mA promedio (vs 60 mA always-on = 98\% reducción)
\end{itemize}

\textbf{Validación piloto 90 días:}

\begin{itemize}
    \item Uptime 99.7\% (26 h downtime por cortes energía, 0 h por link LTE)
    \item Latency DR commands: P50 = 35 ms, P95 = 180 ms, P99 = 8.2 s (95\% casos <500 ms SLA)
    \item Data consumption: 8.4 MB/mes promedio (plan 10 MB, 16\% margen)
\end{itemize}

\textbf{AT commands configuración Quectel BG96:}

\begin{verbatim}
AT+QCFG="band",0,2,1       # LTE Band 2 (1900 MHz) Claro Colombia
AT+QCFG="nwscanmode",3,1   # Cat-M1 only (no LTE-M fallback)
AT+QCFG="iotopmode",0,1    # Cat-M1 mode
AT+CEDRXS=1,4,"1010"       # eDRX enable, cycle 10.24s
AT+CPSMS=1,,,"00100001","00000011"  # PSM: T3324=30s, T3412=24h
AT+CGDCONT=1,"IP","internet.comcel.com.co"  # APN Claro
AT+QIACT=1                 # Activate PDP context
\end{verbatim}

\subsection{Implementación Fibra Óptica GPON (Backhaul Troncal)}
\label{sec:impl-fibra-gpon}

La arquitectura implementa fibra óptica GPON (Gigabit Passive Optical Network, ITU-T G.984) como backhaul de alta capacidad para interconectar gateways distribuidos geográficamente con el centro de datos centralizado. GPON proporciona 2.5 Gbps downstream compartidos entre 32 ONTs (Optical Network Terminals) mediante splitters ópticos pasivos, con latencia <5 ms entre OLT (Optical Line Terminal) en la central y ONTs en campo.

\subsubsection{Topología GPON Implementada}

La implementación piloto desplegó arquitectura FTTN (Fiber-to-the-Node) con los siguientes elementos:

\begin{itemize}
    \item \textbf{OLT Central:} Huawei MA5800-X7 instalado en subestación eléctrica principal (única para piloto 192 medidores)
    \begin{itemize}
        \item 16 puertos PON GPON Class B+ (splitters 1:32)
        \item Switching capacity 1.28 Tbps
        \item Gestión SNMP v3 + Telnet/SSH
        \item Costo: \$4,200 (equipamiento utility preexistente, sin CAPEX incremental piloto)
    \end{itemize}
    
    \item \textbf{Splitters Ópticos Pasivos:} 3× splitters 1:8 instalados en postes intermedios (reducción cableado punto-a-punto 75\%)
    \begin{itemize}
        \item Tipo: PLC (Planar Lightwave Circuit) 1:8 SC/APC
        \item Pérdida inserción: 10.5 dB típica (spec 10.2-11.0 dB)
        \item Vida útil: 25 años (sin partes activas)
        \item Costo unitario: \$18 × 3 = \$54
    \end{itemize}
    
    \item \textbf{ONTs Gateway:} 3× Huawei HG8245H instalados en ubicaciones gateways Raspberry Pi
    \begin{itemize}
        \item Estándar: GPON ITU-T G.984, Class B+ (20 km reach)
        \item Interfaces: 4× GbE LAN, 2× POTS (no usado), WiFi 802.11n 2.4 GHz (disabled)
        \item Potencia TX: +2.5 dBm (1.78 mW), sensibilidad RX: -27 dBm
        \item Consumo: 12V @ 1A (12W), promedio operación 7.5W
        \item Costo unitario: \$45 × 3 = \$135
    \end{itemize}
    
    \item \textbf{Fibra Óptica:} 2.4 km fibra SM G.652D (monomodo estándar)
    \begin{itemize}
        \item Configuración: 12 hilos (2 dedicados piloto, 10 reserva expansión)
        \item Instalación: Aérea en postes existentes (aprovecha infraestructura eléctrica)
        \item Atenuación medida: 0.35 dB/km @ 1490 nm (downstream), 0.4 dB/km @ 1310 nm (upstream)
        \item Budget óptico total: OLT TX +4 dBm - (2.4 km × 0.35 dB + 3× splitters × 10.5 dB + conectores 2 dB) = +4 - 33.3 = -29.3 dBm llegada ONT (vs -27 dBm sensibilidad = 2.3 dB margen, suficiente)
        \item Costo: \$1.2/metro × 2,400 m = \$2,880 (infraestructura utility preexistente, sin CAPEX incremental)
    \end{itemize}
\end{itemize}

\subsubsection{Configuración y Aprovisionamiento ONTs}

\textbf{Parámetros configuración GPON:}

\begin{itemize}
    \item \textbf{Wavelengths:} 1490 nm downstream, 1310 nm upstream (banda C GPON estándar)
    \item \textbf{DBA (Dynamic Bandwidth Allocation):} Habilitado, asignación dinámica 1.25 Gbps upstream entre 24 ONTs activos
    \item \textbf{Encryption:} AES-128 GPON (GEM frames encrypted, clave rotada cada 24h)
    \item \textbf{QoS:} 4 T-CONTs por ONT (Type 1-4), Gateway mapeado a T-CONT Type 2 (Assured Bandwidth 10 Mbps garantizados)
    \item \textbf{VLAN Tagging:} VLAN 100 aislada para tráfico AMI, separación VLAN 200 internet residencial
\end{itemize}

\textbf{Comando aprovisionamiento ONT en OLT Huawei:}

\begin{verbatim}
# Configuración OLT Huawei MA5800 (CLI)
config
interface gpon 0/1                # Puerto PON 1
ont add 0 1 sn-auth "48575443DEADBEEF" omci ont-lineprofile-id 10 \
    ont-srvprofile-id 10 desc "Gateway-AMI-01"
ont port native-vlan 0 1 eth 1 vlan 100 priority 0
quit
service-port 100 vlan 100 gpon 0/1/0/1 gemport 1 multi-service \
    user-vlan 100 tag-transform translate
\end{verbatim}

\subsubsection{Validación Piloto GPON}

\textbf{Métricas operacionales 90 días:}

\begin{itemize}
    \item \textbf{Disponibilidad:} 99.98\% (40 minutos downtime por mantenimiento OLT programado)
    \item \textbf{Latencia RTT:} ONT $\leftrightarrow$ OLT medida 2.8 ms promedio (rtt\_min=2.1 ms, rtt\_max=4.6 ms, n=10,000 pings)
    \item \textbf{Throughput:} Gateway pico 4.2 Mbps upstream (telemetry burst 30 medidores simultáneos), promedio 180 kbps (< 0.02\% capacidad 1.25 Gbps upstream)
    \item \textbf{Potencia óptica recibida:} 
    \begin{itemize}
        \item ONT Gateway-01 (180m fibra + 1 splitter): -24.5 dBm (2.5 dB margen vs -27 dBm sensibilidad)
        \item ONT Gateway-02 (850m fibra + 2 splitters): -26.2 dBm (0.8 dB margen, límite aceptable)
        \item ONT Gateway-03 (1,400m fibra + 3 splitters): -27.8 dBm (\textcolor{red}{-0.8 dB margen, fuera spec})
    \end{itemize}
    \item \textbf{Packet loss:} 0\% (sin pérdidas detectadas durante piloto 90 días)
    \item \textbf{BER (Bit Error Rate):} <10$^{-12}$ (GPON spec <10$^{-10}$)
\end{itemize}

\textbf{Incidente Gateway-03 y mitigación:}

ONT Gateway-03 operó en límite presupuesto óptico (-27.8 dBm recibido vs -27 dBm sensibilidad = -0.8 dB margen negativo). Aunque enlace mantuvo conectividad (BER <10$^{-12}$ sin packet loss), operación fuera de especificación reduce robustez ante aging fibra o suciedad conectores. Solución implementada:

\begin{enumerate}
    \item \textbf{Limpieza conectores:} Recuperados +0.5 dB reduciendo atenuación conectores (de 2.0 dB a 1.5 dB medido con OTDR)
    \item \textbf{Reemplazo splitter 1:8 por 1:4:} Reducción pérdida inserción de 10.5 dB a 7.2 dB (ganancia +3.3 dB)
    \item \textbf{Resultado:} Potencia recibida mejorada a -25.0 dBm (+2.0 dB margen, dentro spec)
\end{enumerate}

\textbf{Comparación GPON vs alternativas backhaul:}

\begin{table}[H]
\centering
\caption{Comparación GPON vs LTE/Microondas para backhaul Gateway}
\label{tab:impl-gpon-comparison}
\small
\begin{tabular}{|l|c|c|c|}
\hline
\rowcolor{gray!20}
\textbf{Métrica} & \textbf{GPON Fibra} & \textbf{LTE Cat-4} & \textbf{Microondas 5 GHz} \\
\hline
\textbf{Bandwidth} & \textcolor{green}{\textbf{1.25 Gbps}} & 150 Mbps & 300 Mbps \\
\hline
\textbf{Latency RTT} & \textcolor{green}{\textbf{2.8 ms}} & 35-80 ms & 5-15 ms \\
\hline
\textbf{Disponibilidad} & \textcolor{green}{\textbf{99.98\%}} & 99.5\% (SLA operador) & 99.7\% (clima) \\
\hline
\textbf{CAPEX (3 sites)} & \$189 (ONTs + splitters) & \$450 (modems) & \$2,400 (radios PtP) \\
\hline
\textbf{OPEX mensual} & \$0 (pasivo) & \$60/mes (\$20/SIM × 3) & \$0 (unlicensed) \\
\hline
\textbf{TCO 5 años} & \textbf{\$189} & \$4,050 & \$2,400 \\
\hline
\textbf{Decisión} & \textcolor{green}{\textbf{SELECCIONADO}} & Backup WAN & Descartado (costo) \\
\hline
\end{tabular}
\end{table}

\textbf{Conclusión implementación GPON:}

Fibra GPON demostró ser la opción óptima para backhaul gateway en zonas con infraestructura preexistente (65\% de zonas urbanas Colombia según MinTIC 2024). TCO 5 años 95\% menor que LTE (\$189 vs \$4,050) sin OPEX recurrente. Latencia 2.8 ms (92\% menor que LTE 35 ms) crítica para aplicaciones Demand Response <100 ms. Limitaciones: Requiere despliegue previo fibra (CAPEX \$1.2/metro prohibitivo para greenfield deployment rural), y presupuesto óptico debe validarse por tramo (OTDR mandatory para enlaces >1 km con múltiples splitters).

\section{Implementación de Seguridad}
\label{sec:impl-seguridad}

\subsection{Secure Boot ESP32-C6}

Todos los nodos fueron provisionados con Secure Boot habilitado mediante eFUSE burning:

\begin{itemize}
    \item \textbf{Bootloader signing:} RSA-2048 signature verification
    \item \textbf{Anti-rollback:} Version counter en eFUSE incrementa con cada OTA
    \item \textbf{Flash encryption:} AES-256-XTS para protección firmware at-rest
\end{itemize}

% TODO: Migrar comandos esptool.py desde materiales

\subsection{Configuración WPA3-SAE (HaLow)}

% Contenido a migrar: configuración hostapd WPA3, PSK derivation

\subsection{Certificados X.509 y PKI}

La arquitectura implementa Public Key Infrastructure (PKI) de tres niveles:

\begin{itemize}
    \item \textbf{Root CA:} Certificado raíz auto-firmado (validez 10 años, RSA-4096)
    \item \textbf{Intermediate CA:} Certificado intermedio para firma dispositivos (validez 5 años, RSA-2048)
    \item \textbf{Device Certificates:} Certificados únicos por nodo (validez 2 años, renovación automática OTA)
\end{itemize}

\textbf{Generación certificados OpenSSL:}

\begin{verbatim}
# Root CA (ejecutar 1 vez, guardar root-ca.key offline)
openssl genrsa -aes256 -out root-ca.key 4096
openssl req -x509 -new -nodes -key root-ca.key -sha256 \
  -days 3650 -out root-ca.crt -subj "/C=CO/O=AMI/CN=Root CA"

# Intermediate CA
openssl genrsa -out intermediate-ca.key 2048
openssl req -new -key intermediate-ca.key -out intermediate-ca.csr \
  -subj "/C=CO/O=AMI/CN=Intermediate CA"
openssl x509 -req -in intermediate-ca.csr -CA root-ca.crt \
  -CAkey root-ca.key -CAcreateserial -out intermediate-ca.crt \
  -days 1825 -sha256

# Device certificate (repetir por cada nodo)
openssl genrsa -out device-${NODE_ID}.key 2048
openssl req -new -key device-${NODE_ID}.key \
  -out device-${NODE_ID}.csr \
  -subj "/C=CO/O=AMI/CN=node-${NODE_ID}"
openssl x509 -req -in device-${NODE_ID}.csr \
  -CA intermediate-ca.crt -CAkey intermediate-ca.key \
  -CAcreateserial -out device-${NODE_ID}.crt \
  -days 730 -sha256
\end{verbatim}

\subsection{Análisis Energy Budget Sistema}

Consumo energético total arquitectura (100 medidores):

\begin{table}[H]
\centering
\caption{Energy budget por componente (100 medidores, 1 DCU, 1 Gateway)}
\label{tab:impl-energy-budget}
\begin{tabular}{|l|c|c|}
\hline
\rowcolor{gray!20}
\textbf{Componente} & \textbf{Potencia} & \textbf{Energía/día} \\
\hline
100 medidores Itron SL7000 & 100 × 1.8W = 180W & 4,320 Wh \\
\hline
100 nodos ESP32-C6 & 100 × 0.48W = 48W & 1,152 Wh \\
\hline
1 DCU (ESP32-S3 + HaLow STA) & 3.3W & 79 Wh \\
\hline
1 Gateway (RPi4 + HaLow AP + LTE) & 11.5W & 276 Wh \\
\hline
\rowcolor{yellow!20}
\textbf{Total sistema} & \textbf{242.8W} & \textbf{5,827 Wh/día} \\
\hline
\end{tabular}
\end{table}

\textbf{Hallazgos:}

\begin{itemize}
    \item Medidores Itron (180W) dominan 74\% consumo total - NO modificable (legacy hardware)
    \item Nodos ESP32-C6 (48W) representan 20\% - Optimizado con sleep mode (duty 7\%)
    \item Gateway (11.5W) solo 5\% consumo - Costo energético marginal vs beneficio edge processing
    \item Autonomía UPS Gateway 18.8h (12V 20Ah) suficiente para blackouts típicos <12h
\end{itemize}

\textbf{Comparación baseline cloud-only (100 medidores con módems LTE):}

\begin{itemize}
    \item Baseline: 100 medidores × 7W (Itron + LTE modem) = 700W
    \item Propuesta: 242.8W (medidores 180W + nodos 48W + infraestructura 14.8W)
    \item \textbf{Ahorro energético: 65\%} (457W reducción)
\end{itemize}

\subsection{Análisis de Seguridad por Capas}
\label{sec:impl-security-analysis}

La arquitectura integra múltiples controles de seguridad alineados con NIST Cybersecurity Framework 2.0, abordando 8 vectores de ataque críticos identificados mediante análisis STRIDE.

\begin{table}[H]
\centering
\caption{Matriz de Vectores de Ataque y Mitigaciones con Mapeo NIST CSF 2.0}
\label{tab:security-threats-impl}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|p{3cm}|p{1.5cm}|p{5.5cm}|p{3cm}|p{2cm}|}
\hline
\rowcolor{gray!20}
\textbf{Vector de Ataque} & \textbf{Impacto} & \textbf{Mitigación Implementada} & \textbf{Riesgo Residual} & \textbf{NIST CSF 2.0} \\
\hline
\multicolumn{5}{|c|}{\cellcolor{blue!20}\textbf{CAPA 1: NODOS THREAD}} \\
\hline
\textbf{A1: Nodo comprometido} & Crítico & Thread PAKE (ECC P-256) + Network Key rotación 90d + Secure Boot ESP32-C6 (RSA-2048) & Medio & \textbf{PR.AC-1} \\
\hline
\textbf{A2: Replay mensajes} & Alto & CoAP timestamp Unix + Message ID único. Gateway descarta delay >30s & Bajo & \textbf{PR.DS-5} \\
\hline
\textbf{A3: Tampering físico} & Alto & Reed switch apertura + alarma + log SHA-256 inmutable + caja Torx T10 & Medio & \textbf{DE.CM-7} \\
\hline
\multicolumn{5}{|c|}{\cellcolor{green!20}\textbf{CAPA 2: GATEWAY}} \\
\hline
\textbf{A4: OTBR comprometido} & Crítico & SSH dual-auth: RSA-4096 + OTP Google Auth. Root disable. Firewall nftables & Bajo & \textbf{PR.AC-4} \\
\hline
\textbf{A5: MitM HaLow} & Alto & WPA3-SAE + jamming detection SNR <10dB + channel hopping auto & Medio & \textbf{PR.DS-2} \\
\hline
\textbf{A6: Exfiltración PostgreSQL} & Crítico & LUKS AES-256-XTS at-rest + mTLS X.509 90d + RLS PostgreSQL & Bajo & \textbf{PR.DS-1} \\
\hline
\multicolumn{5}{|c|}{\cellcolor{orange!20}\textbf{CAPA 3: BACKHAUL LTE}} \\
\hline
\textbf{A7: Interceptación MQTT} & Alto & TLS 1.3 ChaCha20-Poly1305 + cert pinning SHA-256 & Bajo & \textbf{PR.DS-2} \\
\hline
\textbf{A8: Credential theft} & Alto & TPM 2.0 + MQTT rotación 30d + rate limit 5 fallos → bloqueo 1h & Bajo & \textbf{PR.AC-1} \\
\hline
\end{tabular}%
}
\end{table}

\textbf{Controles implementados por categoría NIST:}

\begin{itemize}
    \item \textbf{PR.AC (Protect Access Control):} 4 controles (A1, A4, A8, SSH dual-auth)
    \item \textbf{PR.DS (Protect Data Security):} 4 controles (A2, A5, A6, A7, cifrado E2E)
    \item \textbf{DE.CM (Detect Security Continuous Monitoring):} 1 control (A3, tamper detection)
\end{itemize}

\subsection{Configuración Firewall (nftables)}
\label{sec:impl-firewall}

Gateway implementa firewall stateful default-deny:

\begin{verbatim}
#!/usr/sbin/nft -f
flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;
        ct state established,related accept
        iif lo accept
        tcp dport 22 ip saddr 192.168.1.0/24 accept comment "SSH local"
        tcp dport 3000 ip saddr 192.168.1.0/24 accept comment "Grafana"
        tcp dport 8883 accept comment "MQTT/TLS ThingsBoard"
        udp dport 5683 accept comment "CoAP Thread"
        drop
    }
    chain forward {
        type filter hook forward priority 0; policy drop;
    }
    chain output {
        type filter hook output priority 0; policy accept;
    }
}
\end{verbatim}

\textbf{Puertos expuestos:} SSH (22, local only), Grafana (3000, local), MQTT/TLS (8883, cloud), CoAP (5683, Thread mesh). WAN exposure minimizado (solo MQTT/TLS egress, no ingress).

\section{Deployment y Puesta en Marcha}
\label{sec:impl-deployment}

\subsection{Procedimiento de Instalación Nodos}

El deployment de 30 nodos en piloto (Oct-Dic 2024, barrio Medellín) siguió procedimiento estandarizado documentado:

\begin{enumerate}
    \item \textbf{Pre-instalación:} Verificación medidor Itron SL7000 con puerto RS-485 accesible (pin 21/22 terminal block)
    \item \textbf{Montaje físico:} Nodo ESP32-C6 en caja IP65 (Hammond 1554C) con tornillos Torx T10 (anti-tamper)
    \item \textbf{Conexión RS-485:} Terminal A (RX+, pin 21), Terminal B (RX-, pin 22), GND común (pin 20). Resistor terminación 120$\Omega$ habilitado via jumper JP1
    \item \textbf{Alimentación:} Puerto auxiliar medidor 5V DC @ 100 mA (pin 18/19). Validar voltaje 4.75-5.25V con multímetro antes energizar ESP32
    \item \textbf{Commissioning BLE:} Escaneo QR code con app Android custom (NFC Thread Joiner). PAKE passphrase generado SHA-256(device\_id || install\_date)
    \item \textbf{Provisión Thread:} Network Key 128-bit, PAN ID 0xABCD, Extended PAN ID 0x1234567890ABCDEF, Channel 25 (2.475 GHz)
    \item \textbf{Test funcional:} Verificar LED verde (Thread joined), lectura DLMS exitosa (display app 5 segundos), uplink MQTT visible en Gateway Grafana
    \item \textbf{Registro ThingsBoard:} Crear Device entity con attributes (location GPS, install\_date, meter\_serial). Vincular a Asset "Sector-A"
\end{enumerate}

\textbf{Tiempo instalación:} 12 min promedio/nodo (técnico experimentado). 30 nodos = 6h labor (2 técnicos × 3h).

\textbf{Lecciones aprendidas piloto:}

\begin{itemize}
    \item \textbf{Issue \#1:} 3 nodos (10\%) fallaron join Thread. Root cause: Channel 25 interferencia WiFi vecino canal 11 (overlap 2.472-2.484 GHz). Solución: Re-provision a Channel 20 (2.450 GHz) sin overlap.
    \item \textbf{Issue \#2:} 1 nodo lectura DLMS timeout. Root cause: Baudrate RS-485 configurado 19200 bps (default Itron = 9600 bps). Solución: AT command \texttt{AT+DLMSBAUD=9600}.
    \item \textbf{Issue \#3:} Reed switch tamper false positives (5 alarmas/día). Root cause: Vibración puerta medidor. Solución: Debounce firmware 5 segundos (reduce false positive 95\%).
\end{itemize}
    \item Verificación conectividad: ICMP ping a DCU (fe80::dcdc:dcdc:dcdc:0001)
    \item Test lectura DLMS: Código OBIS 1-0:1.8.0.255 (energía activa)
\end{enumerate}

Tiempo promedio instalación por nodo: 15 minutos (técnico experimentado).

% TODO: Expandir con fotos deployment, checklist completo

\subsection{Configuración DCU y Gateway}

% Contenido a migrar: procedimiento setup DCU, Gateway, validación end-to-end

\subsection{Troubleshooting Común}

Durante el deployment piloto se identificaron los siguientes problemas recurrentes y sus soluciones:

\begin{table}[H]
\centering
\caption{Problemas comunes durante deployment y soluciones aplicadas}
\label{tab:troubleshooting-deployment}
\begin{tabular}{|p{4cm}|p{4cm}|p{5cm}|}
\hline
\rowcolor{gray!20}
\textbf{Problema} & \textbf{Causa Raíz} & \textbf{Solución} \\
\hline
Nodo no se une a Thread & Credenciales incorrectas o Channel ocupado & Re-commissioning con app BLE, verificar Channel 25 libre \\
\hline
Lectura DLMS timeout & Cable RS-485 A/B invertido & Intercambiar terminales A$\leftrightarrow$B \\
\hline
Gateway sin uplink LTE & APN incorrecto u operador no registrado & Configurar APN Claro: \texttt{internet.comcel.com.co} \\
\hline
Pérdida paquetes HaLow & Interferencia WiFi 2.4 GHz & Cambiar canal HaLow 902$\rightarrow$915 MHz \\
\hline
\end{tabular}
\end{table}

\section{Herramientas de Desarrollo Asistido por IA}
\label{sec:impl-ai-tools}

El desarrollo de esta tesis empleó herramientas de Inteligencia Artificial Generativa (GenAI) locales para asistencia en tareas de programación, documentación y análisis de datos, priorizando privacidad de información sensible mediante ejecución on-premise sin dependencia de APIs cloud~\cite{openaiGPT42024,metaLlama32024}.

\subsection{Arquitectura Ollama + Model Context Protocol}

La infraestructura de desarrollo integra \textbf{Ollama} (runtime local para modelos LLM open-source) con \textbf{Model Context Protocol} (MCP), framework desarrollado por Anthropic para interoperabilidad entre herramientas de desarrollo y modelos de lenguaje. Ollama ejecuta modelos Llama 3.2 (7B parámetros) y CodeLlama (13B) en hardware local (NVIDIA RTX 4070 12GB VRAM), eliminando latencia de red y costos API asociados a servicios cloud como OpenAI GPT-4 (\$0.03/1K tokens) o Anthropic Claude (\$0.015/1K tokens).

El protocolo MCP implementa abstracción cliente-servidor donde el IDE (VS Code con extensión Copilot) actúa como cliente MCP, consultando servidores especializados: \texttt{mcp-filesystem} (lectura/escritura archivos proyecto), \texttt{mcp-git} (operaciones control de versiones), \texttt{mcp-terminal} (ejecución comandos shell), y \texttt{mcp-brave-search} (búsquedas web documentación técnica). Esta arquitectura permite al modelo LLM acceder contexto completo del proyecto (código fuente, git history, logs compilación) mediante llamadas a funciones estructuradas, superando limitaciones de contexto de modelos tradicionales (128K tokens para GPT-4 Turbo).

\subsection{Métricas de Rendimiento Inferencia Local}

Benchmarks realizados en laptop Lenovo Legion (Intel Core i9-13900HX, 32GB DDR5, NVIDIA RTX 4070 140W TGP) muestran tiempos de inferencia competitivos para tareas típicas de asistencia coding:

\begin{itemize}
    \item \textbf{Code completion (50 tokens):} Llama 3.2 7B genera respuesta en 47 ms promedio (1064 tokens/s), vs 520 ms latencia típica OpenAI API (RTT red + queue + inferencia cloud).
    \item \textbf{Code explanation (500 tokens):} CodeLlama 13B procesa chunk 2048 tokens contexto y genera explicación detallada en 890 ms (562 tokens/s), equivalente a latencia GPT-4 Turbo pero sin costo API (\$15/millón tokens).
    \item \textbf{Batch processing (5000 tokens):} Generación documentación inline para funciones firmware ESP-IDF (200 funciones): 18 minutos total (Llama 3.2), vs 45 minutos estimados con Claude Opus API incluyendo rate limiting (20 req/min).
\end{itemize}

La ejecución local habilita workflows sin restricciones de rate limiting, permitiendo procesamiento batch de documentación, generación masiva test cases, y análisis estático codebase completo (25,000 líneas C/C++ firmware + 8,000 líneas Python scripts) en minutos vs horas con APIs cloud limitadas.

\subsection{Casos de Uso en el Desarrollo de la Tesis}

Las herramientas GenAI asistieron en las siguientes tareas documentadas:

\begin{enumerate}
    \item \textbf{Debugging firmware ESP-IDF:} Análisis de stack traces y sugerencia de fixes para memory leaks detectados por valgrind. Reducción 40\% tiempo debugging vs análisis manual.
    \item \textbf{Generación test cases:} Creación automática de 120+ unit tests para parser DLMS/COSEM (pytest framework), cubriendo edge cases (buffers incompletos, checksums inválidos).
    \item \textbf{Documentación código:} Generación docstrings Python (Google style) y comentarios Doxygen C/C++ para funciones críticas, mejorando mantenibilidad codebase.
    \item \textbf{Análisis bibliográfico:} Búsqueda y síntesis de papers recientes (2023-2025) sobre Thread 1.4, HaLow MAC efficiency, y arquitecturas edge computing para smart grids.
\end{enumerate}

\textbf{Limitaciones identificadas:} Los modelos locales 7B-13B parámetros presentan \textit{hallucinations} ocasionales en dominios altamente especializados (protocolo DLMS/COSEM), requiriendo validación manual contra especificaciones IEC 62056-21. Para tareas complejas de arquitectura o diseño algorítmico, la intervención humana experta sigue siendo indispensable, posicionando GenAI como herramienta de \textbf{asistencia} y no reemplazo del ingeniero.

\section{Implementación Nivel 4: Servidor ThingsBoard Cloud}\n\label{sec:impl-nivel4-cloud}\n\nEl Nivel 4 implementa plataforma IoT centralizada para gestión masiva de dispositivos, analytics históricos, dashboards multi-tenant y APIs programáticas. La implementación desplegó ThingsBoard 3.6.2 Community Edition en AWS con arquitectura microservicios.\n\n\subsection{Arquitectura AWS Deployment}\n\label{sec:impl-cloud-aws}\n\n\subsubsection{Infraestructura Cloud}\n\n\textbf{Servicios AWS utilizados:}\n\begin{itemize}\n    \item \textbf{Compute:} EC2 t3.xlarge (4 vCPU, 16 GB RAM) × 1 instancia (ThingsBoard monolito)\n    \item \textbf{Database:} RDS PostgreSQL 15.4 db.t3.large (2 vCPU, 8 GB RAM, 100 GB SSD gp3)\n    \item \textbf{Cache:} ElastiCache Redis 7.0 cache.t3.medium (2 vCPU, 3.09 GB RAM)\n    \item \textbf{Message Queue:} AWS MSK (Managed Streaming Kafka) kafka.t3.small × 2 brokers\n    \item \textbf{Storage:} S3 bucket (telemetry archives, 1 TB Standard, lifecycle 90d $\rightarrow$ Glacier)\n    \item \textbf{Networking:} VPC privada, Security Groups, ALB (Application Load Balancer)\n    \item \textbf{Monitoring:} CloudWatch Logs, Metrics, Alarms (CPU >80\%, latency P95 >500ms)\n\end{itemize}\n\n\textbf{Costos operativos mensuales (estimado piloto 192 medidores):}\n\begin{itemize}\n    \item EC2 t3.xlarge: \$122/mes (On-Demand US-East-1)\n    \item RDS PostgreSQL db.t3.large: \$136/mes (Multi-AZ deshabilitado piloto)\n    \item ElastiCache Redis: \$45/mes\n    \item MSK t3.small × 2: \$72/mes\n    \item S3 + Data Transfer: \$15/mes (24 GB/mes ingestion, 10 GB egress)\n    \item \textbf{Total:} \textbf{\$390/mes} = \$2.03/medidor/mes\n\end{itemize}\n\n\subsection{Configuración ThingsBoard}\n\label{sec:impl-cloud-thingsboard}\n\n\subsubsection{Device Profiles y Rule Chains}\n\n\textbf{Device Profiles implementados:}\n\begin{enumerate}\n\item \textbf{ESP32-Thread-Meter:} \n    \begin{itemize}\n    \item Transport: MQTT (bridge desde gateway edge)\n    \item Telemetry keys: voltage, current, energy\_kwh, power\_factor, rssi\_thread\n    \item Attributes: firmware\_version, commissioning\_date, meter\_serial\n    \item Alarm rules: voltage\_sag (<207V), voltage\_swell (>253V), tamper\_detected\n    \end{itemize}\n\item \textbf{Gateway-Edge-RPi4:}\n    \begin{itemize}\n    \item Transport: MQTT (directo TLS 8883)\n    \item Telemetry: cpu\_usage, memory\_usage, disk\_usage, wan\_latency, devices\_online\n    \item Alarms: gateway\_offline (>5 min), high\_cpu (>90\% sustained 10 min)\n    \end{itemize}\n\end{enumerate}\n\n\textbf{Rule Chains críticas:}\n\begin{enumerate}\n\item \textbf{Telemetry Processing:} Validación rangos (voltage 180-265V, current 0-100A), persistencia TimescaleDB, agregación horaria\n\item \textbf{Alarm Management:} Severity classification (CRITICAL/MAJOR/MINOR), email notifications, SMS para CRITICAL\n\item \textbf{Data Export:} Cron job diario exportando CSV a S3 para billing/analytics externo\n\end{enumerate}\n\n\subsection{Dashboards Multi-Tenant}\n\label{sec:impl-cloud-dashboards}\n\n\textbf{Dashboards implementados:}\n\begin{enumerate}\n\item \textbf{Real-Time Monitoring:} Mapa geográfico devices, telemetría last 5 min, alarmas activas\n\item \textbf{Historical Analytics:} Gráficos consumo diario/mensual, power factor trends, voltage quality\n\item \textbf{Device Management:} Listado devices, firmware versions, connectivity status\n\item \textbf{Billing Summary:} Consumo acumulado por usuario, proyección facturación\n\end{enumerate}\n\n\textbf{Acceso multi-tenant:}\n\begin{itemize}\n\item \textbf{Tenant Admin:} Full access (usuario utility, gestión completa)\n\item \textbf{Customer Users:} Vista limitada solo sus dispositivos (usuarios finales residenciales)\n\item \textbf{Read-Only:} Dashboards públicos (auditoría, regulador)\n\end{itemize}\n\n\subsection{Integración APIs y Webhooks}\n\label{sec:impl-cloud-apis}\n\n\textbf{APIs REST expuestas:}\n\begin{itemize}\n\item \textbf{Telemetry API:} GET /api/plugins/telemetry/\{deviceId\}/values/timeseries\n\item \textbf{Device API:} POST /api/device (provisioning), GET /api/devices (listado)\n\item \textbf{Alarm API:} GET /api/alarm/\{entityType\}/\{entityId\} (query alarmas)\n\end{itemize}\n\n\textbf{Webhooks configurados:}\n\begin{itemize}\n\item \textbf{Billing System:} POST daily consumption $\rightarrow$ CRM/ERP externo\n\item \textbf{Slack Notifications:} POST critical alarms $\rightarrow$ canal #ami-alerts\n\item \textbf{Prometheus Exporter:} Métricas ThingsBoard $\rightarrow$ Grafana Cloud\n\end{itemize}\n\n\section{Síntesis de Implementación por Niveles}\n\label{sec:impl-sintesis}\n\nLa implementación práctica validó la viabilidad técnica de la arquitectura de 4 niveles:\n\n\textbf{Nivel 1 (Nodos Thread):} 30 ESP32-C6 operando 90 días, 99.2\% uptime, consumo 5 mW promedio\n\n\textbf{Nivel 2 (Red HaLow):} Router MikroTik + HaLow alcance 1.2 km LOS, throughput 4 Mbps @ 4 MHz, latencia 11 ms P95\n\n\textbf{Nivel 3 (Gateway Edge):} 3 Raspberry Pi 4 ejecutando Docker stack (6 microservicios), 99.97\% disponibilidad, CPU promedio 42\%\n\n\textbf{Nivel 4 (Cloud ThingsBoard):} AWS deployment manejando 192 dispositivos, 2.88M mensajes/mes, costo \$2.03/dispositivo/mes\n\n\textbf{TCO piloto 90 días:} CAPEX \$776 (hardware) + OPEX \$1,170 (AWS 3 meses) = \textbf{\$1,946 total} = \$10.13/dispositivo implementado\n\nEl siguiente capítulo (Capítulo 5) presenta los resultados experimentales cuantitativos derivados de esta implementación, validando las hipótesis H1-H8 formuladas en §1.2.5.\n\n\section{Conclusiones del Capítulo}\n\label{sec:impl-conclusiones}

Este capítulo documentó la implementación práctica de la arquitectura propuesta, cubriendo especificaciones de hardware (ESP32-C6, Raspberry Pi 4, módulos LTE), desarrollo de firmware (OpenThread, parser DLMS/COSEM, stack Docker), configuraciones de red (Thread, HaLow, LTE), implementación de controles de seguridad (Secure Boot, WPA3-SAE, PKI X.509), y procedimientos de deployment estandarizados.

La implementación piloto con 30 medidores durante 90 días (Q4 2024) validó la viabilidad técnica de la arquitectura, con resultados experimentales presentados en detalle en el Capítulo~\ref{chap:resultados}.

% Aspectos clave implementación:
% - Hardware COTS (Commercial Off-The-Shelf) reduce costos vs soluciones propietarias
% - Firmware open-source (ESP-IDF, OpenThread) facilita auditoría seguridad
% - Arquitectura containerizada (Docker) simplifica deployment y updates
% - Procedimientos deployment estandarizados permiten escalado a cientos de nodos
