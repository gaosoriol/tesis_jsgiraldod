\chapter{Diseño de la Arquitectura de Telemetría: 4 Niveles Jerárquicos}
\label{chap:arquitectura}

\section{Introducción}

Este capítulo presenta el diseño conceptual de la arquitectura propuesta, estructurada en cuatro niveles jerárquicos que cubren desde la adquisición de datos en medidores hasta el almacenamiento y analítica centralizada. La arquitectura implementa un modelo edge computing distribuido que optimiza latencia, escalabilidad y costos operativos para aplicaciones de Advanced Metering Infrastructure (AMI) en Smart Energy~\cite{alsafranChallengesImplementingIoT2025,velasquezSmartGridsEmpowered2024}.

Las redes eléctricas inteligentes requieren arquitecturas capaces de gestionar decenas de miles de medidores distribuidos geográficamente, con requisitos estrictos de latencia (<1s para AMI según IEC 62056), disponibilidad (>99.5\% SLA típico), y eficiencia energética (<5W por nodo). La transición desde arquitecturas cloud-centric hacia modelos edge computing responde a tres desafíos: (1) escalabilidad de última milla sin costos prohibitivos de celular, (2) reducción de latencia mediante procesamiento local, y (3) cumplimiento de regulaciones de privacidad procesando datos sensibles localmente.

\section{Visión General: Arquitectura Jerárquica de 4 Niveles}

\subsection{Modelo Jerárquico y Responsabilidades por Nivel}

La arquitectura propuesta implementa cuatro niveles especializados, cada uno con responsabilidades específicas de adquisición, transporte, procesamiento y almacenamiento de datos~\cite{choudharyInternetThingsComprehensive2024,tangResearchInteroperabilityIoT}:

\begin{enumerate}
    \item \textbf{Nivel 1 - Red de Campo (Field Network)}: Sensores Thread y medidores DLMS/COSEM. Nodos adaptadores ESP32-C6 con radio IEEE 802.15.4 traducen protocolos y forman red mesh autoconfigurable. Responsabilidad: adquisición y traducción de datos en el punto de medición.
    
    \item \textbf{Nivel 2 - Infraestructura de Distribución Híbrida}: Fibra óptica GPON (backhaul troncal) + Wi-Fi HaLow IEEE 802.11ah (último salto). Border Routers Thread agregan hasta 100 medidores c/u. Responsabilidad: transporte de datos desde clusters de medidores hacia gateway con alta capacidad y alcance extendido.
    
    \item \textbf{Nivel 3 - Pasarela de Borde (Edge Gateway)}: Hardware industrial ejecutando ThingsBoard Edge con Rule Engine y TimescaleDB local. Procesamiento edge reduce 72\% tráfico WAN mediante filtrado y agregación. Responsabilidad: inteligencia local, operación autónoma durante pérdida de conectividad, y sincronización selectiva a cloud.
    
    \item \textbf{Nivel 4 - Plataforma Central ThingsBoard Cloud}: Servidor PE en AWS con PostgreSQL Multi-AZ. Asset Topology jerárquica, analítica batch, integración SCADA/CIS. Responsabilidad: almacenamiento histórico, dashboards multi-tenant, reportes regulatorios, y predicción de demanda.
\end{enumerate}

\begin{figure}[h]
\centering
\includegraphics[width=0.95\textwidth]{figures/arquitectura-completa.png}
\caption{Arquitectura completa del sistema de telemetría: cuatro capas (dispositivos, campo Thread, agregación HaLow, cloud ThingsBoard) con procesamiento edge y reducción 72\% tráfico WAN}
\label{fig:arquitectura-completa}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=0.9\textwidth]{figures/flujo-datos-edge.png}
\caption{Flujo de datos y procesamiento en el borde (\textit{edge}): desde medidores DLMS/COSEM (línea base 24.6 GB/día) hasta nube (\textit{cloud}) ThingsBoard (6.9 GB/día). Pasarela (\textit{Gateway}) con ThingsBoard Edge ejecuta Motor de Reglas (\textit{Rule Engine}) + CEP para procesamiento local, logrando reducción 72\% tráfico WAN y latencia 8±2 ms}
\label{fig:flujo-datos-edge}
\end{figure}

\subsection{Descripción de Niveles de Arquitectura}

\subsubsection{Nivel 1: Medidores y Nodos IoT}

El primer nivel comprende los medidores inteligentes (Itron SL7000, Landis+Gyr E650) con interfaces DLMS/COSEM sobre RS-485, y los nodos adaptadores IoT basados en ESP32-C6 con radio IEEE 802.15.4 para protocolo Thread. Cada medidor se conecta mediante puerto óptico o RS-485 (9600 bps) a un nodo IoT que ejecuta firmware ESP-IDF 5.1 con stack OpenThread 1.3.0. Los nodos operan en modo \textit{Sleepy End Device} (SED) con ciclo de trabajo 0.1\% (despierta cada 15 minutos para lectura), consumiendo 233 mW promedio incluyendo medidor en standby~\cite{krawiecEnergyFootprintReliability2025}. La traducción de protocolos DLMS/COSEM a CoAP/JSON se realiza en el nodo IoT, encapsulando códigos OBIS (voltage, current, active/reactive energy) en payloads de 200 bytes que se transmiten mediante Thread mesh hacia el siguiente nivel.

\subsubsection{Nivel 2: Border Router y Gateway Edge}

El segundo nivel integra dos componentes críticos: el \textit{Thread Border Router} (OTBR) basado en nRF52840 que actúa como puente entre la red Thread mesh (IEEE 802.15.4) y la red IP tradicional, y el Gateway Edge que ejecuta ThingsBoard Edge en hardware industrial (Raspberry Pi CM4 o equivalente x86). El OTBR soporta hasta 100 nodos Thread en una única partición (\textit{partition}), con latencia típica 5 ms/hop en topologías mesh de hasta 4 hops. El Gateway Edge procesa mensajes CoAP/MQTT, ejecuta el Motor de Reglas (\textit{Rule Engine}) de ThingsBoard para filtrado y agregación local, y almacena datos en base TimescaleDB embebida. Este nivel logra reducción del 72\% del tráfico WAN mediante políticas de retención edge: solo se sincronizan a la nube eventos críticos (alarmas, desconexiones) y agregados horarios de métricas, reduciendo de 24.6 GB/día a 6.9 GB/día el volumen transmitido~\cite{alsafranChallengesImplementingIoT2025}. El consumo energético del Gateway Edge es 11.5 W continuos (3.3 W OTBR + 8.2 W Raspberry Pi CM4).

\subsubsection{Nivel 3: Fibra Óptica y Backhaul WAN}

El tercer nivel provee conectividad de última milla (\textit{last-mile}) entre el Gateway Edge y la infraestructura de red del operador, utilizando fibra óptica en arquitectura FTTN (\textit{Fiber-to-the-Node}) o FTTC (\textit{Fiber-to-the-Curb}) con ONT activas. La implementación típica usa tecnología GPON (ITU-T G.984) con splitting ratio 1:32, donde cada fibra troncal desde la central OLT (\textit{Optical Line Terminal}) alimenta hasta 32 ONTs distribuidas geográficamente. Cada ONT proporciona puerto Ethernet GbE al Gateway Edge, con latencia típica 2-5 ms y disponibilidad 99.9\% según SLA operador. En zonas sin cobertura FTTH, se utilizan enlaces de respaldo LTE Cat-M1 con latencia 25-50 ms y costos operativos \$8-12/mes por gateway.

La arquitectura de fibra implementa redundancia mediante dual-homing: el Gateway Edge soporta dos uplinks WAN (primario: fibra GPON, secundario: LTE Cat-M1) con conmutación automática en <10 segundos ante fallo del enlace primario. Esta configuración reduce el downtime de 8.18 horas/año (99.91\% uptime con enlace único) a <30 minutos/año (99.99\% uptime con redundancia), cumpliendo requisitos SLA para infraestructura crítica AMI.

\subsubsection{Nivel 4: Servidor ThingsBoard Cloud}

El cuarto nivel corresponde a la plataforma IoT centralizada ThingsBoard Professional Edition (PE) desplegada en infraestructura AWS (instancia EC2 t3.xlarge: 4 vCPU, 16 GB RAM) con base de datos PostgreSQL 14 en RDS Multi-AZ para alta disponibilidad. ThingsBoard PE proporciona funcionalidades avanzadas de multi-tenancy, permitiendo segregar datos por cliente/región mediante \textit{Asset Topology}: cada distribuidora eléctrica se modela como Customer con jerarquía Asset (Subestación → Alimentador → Transformador → Medidor), habilitando control de acceso granular RBAC (\textit{Role-Based Access Control}) y dashboards personalizados por tenant.

El \textit{Rule Engine} centralizado ejecuta analítica batch sobre datasets históricos, incluyendo detección de anomalías mediante ventanas deslizantes (consumo $>3\sigma$ respecto baseline 30 días), predicción de demanda con modelos ARIMA entrenados en Spark, y generación de reportes regulatorios (CREG 015 formato XML). La arquitectura cloud soporta escalabilidad horizontal mediante cluster Kafka (3 brokers) para ingesta de mensajes MQTT desde 10,000+ gateways edge distribuidos, con throughput sostenido 50,000 msg/s y latencia percentil 99 de 15 ms en procesamiento Rule Engine.

\section{Nivel 1: Red de Campo - Sensores Thread y Medidores Inteligentes}
\label{sec:nivel1}

Este nivel implementa la adquisición de datos desde medidores inteligentes mediante nodos adaptadores ESP32-C6 que actúan como puente entre el bus RS-485 del medidor (protocolo DLMS/COSEM según IEC 62056) y la red Thread mesh (IEEE 802.15.4 con IPv6 nativo).

\subsection{Comparación de Medidores Inteligentes}

La selección del medidor impacta directamente costos CAPEX, compatibilidad de protocolos, y vida útil del despliegue. La tabla~\ref{tab:meter-comparison} compara tres medidores certificados para AMI.

\begin{table}[H]
\centering
\caption{Comparación técnica de medidores inteligentes certificados AMI para residencial monofásico 120V}
\label{tab:meter-comparison}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|l|c|c|c|}
\hline
\rowcolor{gray!20}
\textbf{Característica} & \textbf{Itron SL7000} & \textbf{Landis+Gyr E650} & \textbf{Elster AS3000} \\
\hline
Clase precisión & \textcolor{green}{\textbf{0.2\%}} (ANSI C12.20) & 0.5\% & 0.5\% \\
\hline
Protocolo estándar & \textcolor{green}{\textbf{DLMS/COSEM}} IEC 62056 & Propietario + DLMS & Modbus RTU \\
\hline
Interfaz física & RS-485 + Puerto óptico & RS-485 & \textcolor{red}{Solo RS-232} \\
\hline
Códigos OBIS & \textcolor{green}{\textbf{Nativo}} & Emulado (firmware) & \textcolor{red}{No soporta} \\
\hline
Precio unitario (2024) & \textcolor{green}{\textbf{\$85}} & \$145 & \$62 \\
\hline
Vida útil certificada & 15 años & 20 años & 10 años \\
\hline
Consumo standby & 1.8W & 2.2W & 1.5W \\
\hline
Display LCD & Sí (7-segment) & Sí (dot-matrix) & \textcolor{red}{No} \\
\hline
\textbf{Decisión} & \textcolor{green}{\textbf{SELECCIONADO}} & Descartado (costo) & Descartado (protocolo) \\
\hline
\end{tabular}%
}
\end{table}

\textbf{Decisión arquitectónica: Itron SL7000}

Seleccionado por tres ventajas críticas: (1) DLMS/COSEM nativo sin firmware propietario, (2) precio \$85 vs \$145 Landis+Gyr (41\% CAPEX savings para 10K medidores = \$600K ahorro), (3) clase precisión 0.2\% cumple regulación CREG 070 de 1998 (error máximo ±0.5\% permitido). Trade-off aceptado: vida útil 15 años vs 20 años Landis+Gyr, mitigado por roadmap de upgrade tecnológico cada 12-15 años típico en utilities.

\subsection{Protocolo DLMS/COSEM y Códigos OBIS}

DLMS (Device Language Message Specification) según IEC 62056-5-3 define el modelo de objetos COSEM (\textit{Companion Specification for Energy Metering}) que estandariza la representación de magnitudes eléctricas. Cada registro se identifica mediante código OBIS (Object Identification System) con formato A-B:C.D.E*F.

\begin{table}[H]
\centering
\caption{Códigos OBIS críticos para telemetría AMI residencial monofásica}
\label{tab:obis-codes}
\begin{tabular}{|l|l|p{5cm}|c|}
\hline
\rowcolor{gray!20}
\textbf{Código OBIS} & \textbf{Unidad} & \textbf{Descripción} & \textbf{Frecuencia} \\
\hline
0-0:1.8.0*255 & kWh & Energía activa acumulada total (importada) & 15 min \\
\hline
0-0:2.8.0*255 & kWh & Energía activa exportada (generación distribuida) & 15 min \\
\hline
1-0:32.7.0*255 & V & Tensión instantánea fase L1 & 1 min \\
\hline
1-0:31.7.0*255 & A & Corriente instantánea fase L1 & 1 min \\
\hline
1-0:1.7.0*255 & W & Potencia activa instantánea & 1 min \\
\hline
1-0:13.7.0*255 & - & Factor de potencia instantáneo & 1 min \\
\hline
0-0:96.11.0*255 & - & Eventos tamper (magnético/físico) & Asíncrono \\
\hline
\end{tabular}
\end{table}

\textbf{Seguridad DLMS: High Level Security (HLS)}

DLMS soporta 5 niveles de autenticación (Level 0 no security → Level 4-5 SHA-256/AES-GCM). Arquitectura implementa HLS Level 4: handshake AARQ/AARE con challenge-response SHA-256, protegiendo contra replay attacks y man-in-the-middle.

\subsection{Diseño de Red Thread Mesh}

La red de campo implementa protocolo Thread (basado en IEEE 802.15.4) formando una topología mesh autoconfigurable. Thread se seleccionó sobre alternativas (Zigbee, BLE Mesh) por tres ventajas: (1) IPv6 nativo extremo-a-extremo, (2) latencia 36-41\% menor en configuraciones multi-hop, y (3) interoperabilidad directa con IEEE 2030.5 Smart Energy Profile que especifica transporte CoAP/UDP sobre IPv6.

\subsubsection{Justificación de Thread vs Zigbee para AMI Smart Energy}

La selección de Thread 1.4.0 sobre Zigbee 3.0 (ambos basados en IEEE 802.15.4) requiere justificación técnica explícita. La tabla~\ref{tab:thread-vs-zigbee} presenta comparación sistemática según criterios AMI.

\begin{table}[H]
\centering
\caption{Comparación Thread 1.4.0 vs Zigbee 3.0 para Smart Energy AMI}
\label{tab:thread-vs-zigbee}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|l|c|c|p{5.5cm}|}
\hline
\rowcolor{gray!20}
\textbf{Criterio} & \textbf{Thread 1.4.0} & \textbf{Zigbee 3.0} & \textbf{Análisis y Justificación} \\
\hline
\textbf{IPv6 nativo E2E} & \textcolor{green}{\textbf{Sí}} & No & Thread provee IPv6 end-to-end, eliminando NAT/gateway de traducción requerido por Zigbee. Reduce latencia 40-60\% y simplifica arquitectura. \\
\hline
\textbf{Interoperabilidad IEEE 2030.5} & Directo & Gateway & El standard Smart Energy Profile 2.0 (IEEE 2030.5-2018) asume IPv6 nativo. Thread implementa directamente, Zigbee requiere ALG. \\
\hline
\textbf{Ecosistema IoT} & Emergente & Maduro (15 años) & Zigbee tiene mayor cantidad de dispositivos certificados. Thread emergió en 2019 con respaldo Google, Apple, Amazon. \\
\hline
\textbf{Costo módulos (2024)} & \$5-8 & \$3-5 & Zigbee 40\% más económico. Diferencial se reduce con adopción Matter. \\
\hline
\textbf{Consumo energético} & 5-10 mA sleep & 3-5 mA sleep & Zigbee menor consumo. En esta arquitectura nodos alimentados desde medidor (5V disponible), no limitante. \\
\hline
\textbf{Seguridad} & AES-128-CCM-8 & AES-128-CCM & Thread añade PAKE con ECC P-256 para commissioning (más robusto que Install Code Zigbee). \\
\hline
\textbf{Latencia típica} & \textcolor{green}{\textbf{50-90 ms}} & 100-150 ms & Thread menor latencia por ausencia de gateway de traducción Zigbee→IP. \\
\hline
\textbf{Commissioning} & PAKE (ECC P-256) & Install Code & PAKE resiste ataques de diccionario offline, crítico para infraestructura expuesta. \\
\hline
\end{tabular}%
}
\end{table}

\textbf{Decisión final: Thread 1.4.0}

Thread seleccionado por tres ventajas críticas que superan desventajas de costo y madurez: (1) Arquitectura simplificada con IPv6 E2E elimina gateway de traducción, reduciendo latencia 40-60\% (150 ms → 90 ms típico), (2) Cumplimiento directo IEEE 2030.5 sin ALG, (3) Roadmap convergencia Matter garantiza soporte largo plazo (15-20 años vida útil infraestructura AMI).

\textbf{Trade-offs aceptados}: Mayor costo módulos (\$5-8 vs \$3-5) compensado por eliminación gateway traducción (\$200-400 por DCU). Balance neto: arquitectura Thread resulta equivalente o más económica.

\subsection{Análisis de Vectores de Ataque y Mitigaciones}

La arquitectura integra múltiples protocolos (Thread, HaLow, LTE) incrementando superficie de ataque. Esta sección presenta análisis sistemático de amenazas críticas, alineado con NIST Cybersecurity Framework (CSF) v2.0.

\begin{table}[h]
\centering
\caption{Matriz de Vectores de Ataque, Impacto y Mitigaciones con Mapeo NIST CSF 2.0}
\label{tab:security-threats}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|p{3cm}|p{1.5cm}|p{1.5cm}|p{5cm}|p{2.5cm}|p{2cm}|}
\hline
\rowcolor{gray!20}
\textbf{Vector de Ataque} & \textbf{Impacto} & \textbf{Probab.} & \textbf{Mitigación Implementada} & \textbf{Riesgo Residual} & \textbf{NIST CSF 2.0} \\
\hline
\multicolumn{6}{|c|}{\cellcolor{blue!20}\textbf{CAPA 1: NODOS DE CAMPO (THREAD MESH)}} \\
\hline
\textbf{A1: Nodo comprometido} & Crítico & Baja & Thread Commissioning PAKE (ECC P-256) + Network Key rotación 90d + Secure Boot ESP32-C6 (RSA-2048) & Medio: Requiere acceso físico bypass Secure Boot & \textbf{PR.AC-1} Protect: Access Control \\
\hline
\textbf{A2: Replay mensajes Thread} & Alto & Media & CoAP timestamp Unix + Message ID único. Gateway descarta delay >30s o MID duplicado ventana 100 msgs. & Bajo: Ventana 30s permite replay <30s & \textbf{PR.DS-5} Protect: Data Integrity \\
\hline
\textbf{A3: Physical tampering nodo} & Alto & Media & Reed switch detección apertura + alarma gateway + log inmutable TimescaleDB hash SHA-256. Caja Torx T10. & Medio: Alarma reactiva, no previene acceso & \textbf{DE.CM-7} Detect: Physical Security \\
\hline
\multicolumn{6}{|c|}{\cellcolor{green!20}\textbf{CAPA 2: GATEWAY (OTBR + HALOW AP)}} \\
\hline
\textbf{A4: OTBR comprometido} & Crítico & Baja & SSH dual-auth: (1) RSA-4096 key + (2) OTP Google Authenticator. Root disable. Firewall nftables drop INPUT excepto 22/tcp whitelist. & Bajo: Requiere private key + OTP seed & \textbf{PR.AC-4} Protect: Least Privilege \\
\hline
\textbf{A5: MitM HaLow} & Alto & Media & WPA3-SAE resiste diccionario offline. RAW mode detección jamming SNR <10dB alarma. Channel hopping auto 2/4/8 MHz. & Medio: Jamming multi-banda DoS temporal & \textbf{PR.DS-2} Protect: Data in Transit \\
\hline
\textbf{A6: Exfiltración PostgreSQL} & Crítico & Baja & TimescaleDB: (1) LUKS dm-crypt AES-256-XTS at-rest, (2) mTLS X.509 renovado 90d, (3) RLS PostgreSQL limita queries/rol. & Bajo: Requiere cert + bypass RLS & \textbf{PR.DS-1} Protect: Data at Rest \\
\hline
\multicolumn{6}{|c|}{\cellcolor{orange!20}\textbf{CAPA 3: BACKHAUL (LTE CAT-M1)}} \\
\hline
\textbf{A7: Interceptación MQTT} & Alto & Media & TLS 1.3 ChaCha20-Poly1305 + cert pinning SHA-256 broker hardcoded. TLS 1.2 fallback disable. & Bajo: Requiere compromiso CA raíz & \textbf{PR.DS-2} Protect: Data in Transit \\
\hline
\textbf{A8: Credential theft MQTT} & Alto & Media & Credenciales TPM 2.0. MQTT user/pass rotación 30d auto. Rate limit: 5 fallos → bloqueo IP 1h. & Bajo: TPM resiste ataques físicos lab & \textbf{PR.AC-1} Protect: Access Control \\
\hline
\end{tabular}%
}
\end{table}

\textbf{Assessment NIST CSF 2.0 - Tier 3 Repeatable:}

La arquitectura implementa defensa en profundidad con controles en 8 capas (firmware Secure Boot, Thread/DTLS, HaLow WPA3-SAE, gateway AppArmor, TPM, MQTT TLS 1.3, cloud mTLS, PostgreSQL encryption-at-rest), logrando NIST CSF Tier 3 (Repeatable). Riesgos residuales identificados requieren roadmap de mitigación para producción (HSM, eFUSE JTAG\_DIS, SIEM cloud).

\section{Nivel 2: Infraestructura de Distribución Híbrida (Fibra + HaLow)}

El segundo nivel implementa infraestructura que conecta clusters de 30-100 medidores con gateway de borde, utilizando fibra óptica GPON para backhaul troncal y Wi-Fi HaLow para último salto entre gateway y Border Routers Thread.

\subsection{Fibra Óptica FTTN/FTTC: Backhaul Troncal}

La llegada de fibra óptica al barrio (FTTN) o acera (FTTC) mediante arquitectura GPON (ITU-T G.984) proporciona backhaul de alta capacidad. Topología GPON implementa splitting ratio 1:32, donde una fibra troncal desde OLT alimenta hasta 32 ONTs mediante splitters ópticos pasivos.

\textbf{Características técnicas GPON:}
\begin{itemize}
    \item \textbf{Capacidad agregada}: 2.5 Gbps downstream / 1.25 Gbps upstream compartidos entre 32 ONTs
    \item \textbf{Latencia}: 2-5 ms ONT-OLT, disponibilidad 99.9\% según SLA operador (8.76 h downtime/año), mejorada a 99.99\% (52 min/año) mediante dual-homing con respaldo LTE Cat-M1
    \item \textbf{Alcance}: Hasta 20 km entre OLT y ONT, habilitando centralización de OLT en subestaciones eléctricas
\end{itemize}

\subsection{Wi-Fi HaLow (802.11ah): Último Salto Gateway-Medidores}

HaLow (802.11ah) ofrece ventajas significativas sobre WiFi tradicional: alcance hasta 1 km en línea de vista (vs 100m WiFi 2.4 GHz), mejor penetración en interiores (banda sub-1 GHz), menor consumo mediante modos de ahorro energético (TIM, RAW), y soporte de miles de clientes por AP~\cite{ieee80211ah2020,halowVsLoRaWANComparison2023}. Opera en banda 902-928 MHz (ISM región América) con seguridad WPA3-SAE resistente a ataques de diccionario.

\subsection{Análisis de Uplink WAN: LTE Cat-M1}

El Gateway requiere conectividad WAN para publicar datos agregados a ThingsBoard Cloud. Esta subsección compara tres tecnologías LTE para IoT y justifica selección de Cat-M1.

\begin{table}[H]
\centering
\caption{Comparación LTE Cat-M1 vs Cat-NB1 (NB-IoT) vs Cat-1 para backhaul WAN Gateway}
\label{tab:lte-comparison}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|p{3.5cm}|p{3.5cm}|p{3.5cm}|p{3.5cm}|}
\hline
\rowcolor{gray!20}
\textbf{Característica} & \textbf{LTE Cat-M1 (eMTC)} & \textbf{LTE Cat-NB1 (NB-IoT)} & \textbf{LTE Cat-1} \\
\hline
\textbf{Throughput downlink} & \textcolor{blue}{\textbf{1 Mbps}} & 250 kbps (multi-tone) & \textcolor{green}{\textbf{10 Mbps}} \\
\hline
\textbf{Throughput uplink} & \textcolor{green}{\textbf{375 kbps}} & 250 kbps (single-tone), 20 kbps (typical) & 5 Mbps \\
\hline
\textbf{Latency típica} & \textcolor{green}{\textbf{10-50 ms}} & \textcolor{orange}{1.6-10 s} (depende PSM) & \textcolor{green}{\textbf{50-100 ms}} \\
\hline
\textbf{Consumo TX} & 220 mA @ 23 dBm & \textcolor{green}{\textbf{120 mA @ 23 dBm}} & \textcolor{red}{500 mA @ 23 dBm} \\
\hline
\textbf{Movilidad} & Hasta 80 km/h con handover & \textcolor{orange}{Limitada (fixed/nomadic)} & \textcolor{green}{\textbf{Hasta 350 km/h}} \\
\hline
\textbf{VoLTE support} & \textcolor{green}{\textbf{Sí}} (half-duplex) & \textcolor{red}{No} & \textcolor{green}{\textbf{Sí}} (full-duplex) \\
\hline
\textbf{Costo módulo (2024)} & \textcolor{green}{\textbf{\$8-12}} & \$6-10 & \textcolor{orange}{\$15-25} \\
\hline
\textbf{Costo data plan (típico)} & \textcolor{green}{\textbf{\$5-10/mes}} (10-50 MB) & \$3-8/mes (5-20 MB) & \$15-30/mes (500 MB - 1 GB) \\
\hline
\textbf{Sunset timeline} & \textcolor{green}{\textbf{Post-2035}} (roadmap 5G RedCap coexistencia) & Post-2035 & \textcolor{orange}{2028-2030} (migración a 5G) \\
\hline
\end{tabular}%
}
\end{table}

\textbf{Decisión de Arquitectura: LTE Cat-M1 Seleccionado}

Cat-M1 seleccionado por balance óptimo entre throughput, latencia y consumo energético:

\textbf{(1) Throughput adecuado:} Gateway con 1,000 medidores genera tráfico uplink 26.4 kbps promedio, picos burst 53 kbps. Cat-M1 uplink 375 kbps >> 53 kbps: 7× margen. Cat-NB1 (20 kbps typical) insuficiente.

\textbf{(2) Latencia baja crítica:} Demand Response (DR) requiere latencia <500 ms E2E. Cat-M1 latency 10-50 ms permite cumplir requisito. Cat-NB1 latency 1.6-10 s viola spec IEEE 2030.5.

\textbf{(3) Costo-beneficio vs Cat-1:} Módulo \$8-12 Cat-M1 vs \$15-25 Cat-1 = 40-50\% ahorro CAPEX. Data plan \$5-10/mes vs \$15-30/mes = 50-66\% ahorro OPEX. Deployment 10 Gateways: OPEX saving \$1,500/año, payback inmediato.

\textbf{Configuración eDRX y PSM:} eDRX cycle 10.24s reduce consumo RX 99\% (60 mA continuo → 0.58 mA promedio). PSM con T3324=30s active + T3412=24h periodic TAU logra consumo promedio 1.03 mA (98\% reducción vs always-on). Validación piloto Q4 2024: 10 Gateways, consumo medido 1.1 mA promedio, uptime 99.7\%, latency DR commands P95=180 ms.

\subsection{Operación Multi-Protocolo: BLE Commissioning + Thread Data Transfer}

Los nodos ESP32-C6 implementan operación concurrente BLE + Thread. BLE usado exclusivamente para commissioning inicial (PAKE con ECC P-256, 2-5 min por nodo) y mantenimiento on-demand. Thread opera 24/7 para transmisión telemetría. Time-slicing autónomo con overhead <5\%, validado por Nordic Semiconductor~\cite{NordicThread2024}.

\textbf{Uso de BLE:} (1) Commissioning inicial vía app móvil (escaneo QR code → conexión GATT → transferencia credenciales Thread → almacenamiento NVS cifrado AES-256), (2) Debug y diagnóstico on-demand (lectura logs, verificación RSSI, test frame Thread), (3) Firmware OTA recovery fallback.

\textbf{Uso de Thread:} Operación continua para lecturas periódicas (cada 15 min), mesh routing, keep-alive (cada 5 min MLE Advertisement). Duty-cycle: RX activo 100\% (19 mA) para forwarding mesh, TX solo durante lecturas (22 mA, 2-5s cada 15 min). Consumo promedio: 19.2 mA ≈ 0.48W a 5V.

\section{Nivel 3: Pasarela de Borde con Procesamiento Edge Inteligente}

El tercer nivel implementa el gateway de borde (Raspberry Pi CM4) ejecutando ThingsBoard Edge para procesamiento local mediante Rule Engine, agregación/compresión 72\% tráfico WAN, y operación autónoma durante pérdida conectividad backhaul hasta 72 horas.

\subsection{Funciones del Gateway Edge}

El Gateway realiza: (1) Recepción datos DCUs por HaLow, (2) Rule Engine local para detección anomalías (sobretensión >1.1 pu, desbalance fases >10\%, pérdida comunicación >5 min, consumo anómalo >3σ), (3) Agregación temporal con continuous aggregates TimescaleDB (rollups 15-min/1-hour/1-day precomputados), (4) Compresión: eliminación lecturas redundantes (delta <0.1 kWh descartado), run-length encoding para perfiles estables → 72\% reducción tráfico WAN, (5) Buffer offline con cola persistente PostgreSQL (capacidad 72h telemetría, 90 GB para 1000 medidores), (6) Publicación MQTT/TLS a ThingsBoard Cloud (puerto 8883), (7) Reconexión automática con backoff exponencial (1s, 2s, 4s, ..., max 60s).

\textbf{Arquitectura Docker:} Docker Compose orquestando 7 containers: ThingsBoard Edge 3.6, PostgreSQL 14 + TimescaleDB 2.11, Mosquitto 2.0, Node-RED 3.0, Grafana 10, Kafka 3.4 (opcional), Nginx reverse proxy.

\subsection{Comparación de Plataformas Edge Computing}

La selección de plataforma edge impacta flexibilidad Rule Engine, escalabilidad, y vendor lock-in. La tabla~\ref{tab:edge-platforms-comparison} compara ThingsBoard Edge con alternativas comerciales.

\begin{table}[H]
\centering
\caption{Comparación plataformas edge computing IoT: ThingsBoard Edge vs AWS Greengrass vs Azure IoT Edge}
\label{tab:edge-platforms-comparison}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|p{3cm}|p{3.5cm}|p{3.5cm}|p{3.5cm}|}
\hline
\rowcolor{gray!20}
\textbf{Característica} & \textbf{ThingsBoard Edge 3.6} & \textbf{AWS IoT Greengrass v2} & \textbf{Azure IoT Edge 1.4} \\
\hline
\textbf{Licencia} & \textcolor{green}{\textbf{Apache 2.0 (open-source)}} + PE comercial & Propietario AWS (gratis software, pago servicios cloud) & Propietario Microsoft \\
\hline
\textbf{Rule Engine lenguajes} & \textcolor{blue}{\textbf{JavaScript (Nashorn/GraalVM)}} + Java classes & Python 3.x (Lambda functions) + containers & C\#/.NET 6 (Azure Functions) + Python/Java \\
\hline
\textbf{Dispositivos máx} & \textcolor{orange}{\textbf{5,000}} (Community), unlimited (Pro) & Unlimited & Unlimited \\
\hline
\textbf{RAM requerida} & \textcolor{green}{\textbf{2 GB mínimo}} (4 GB recomendado) & 4 GB mínimo (8 GB recomendado) & 4 GB mínimo \\
\hline
\textbf{Time-series optimization} & \textcolor{green}{\textbf{TimescaleDB 2.x}} (hypertables, continuous aggregates, compresión 10:1) & Requiere AWS Timestream (cloud, no local) & Azure Time Series Insights (deprecado 2025) \\
\hline
\textbf{Dashboard local} & \textcolor{green}{\textbf{Sí}} (React frontend, editable drag\&drop) & \textcolor{red}{\textbf{No}} (requiere AWS IoT SiteWise cloud) & \textcolor{red}{\textbf{No}} (requiere Power BI cloud) \\
\hline
\textbf{Offline operation} & \textcolor{green}{\textbf{Full-featured}} (dashboards, rules, DB queries sin WAN) & Parcial (processing OK, dashboards no) & Parcial (modules ejecutan, no dashboards) \\
\hline
\textbf{Costo licencia} & \textcolor{green}{\textbf{\$0}} (Community) o \$0.50/device/mes (Pro) & \$0 software + \$0.15/million msgs cloud & \$0 runtime + \$0.25/device/mes IoT Hub \\
\hline
\textbf{Vendor lock-in} & \textcolor{green}{\textbf{Bajo}} (portable, open APIs, export fácil) & \textcolor{red}{\textbf{Alto}} (integración profunda AWS) & \textcolor{red}{\textbf{Alto}} (integración Azure) \\
\hline
\end{tabular}%
}
\end{table}

\textbf{Decisión de Arquitectura: ThingsBoard Edge Seleccionado}

ThingsBoard Edge seleccionado por cinco ventajas críticas:

\textbf{(1) Operación offline completa:} Dashboards React en puerto 8080, Rule Engine ejecuta JavaScript localmente, PostgreSQL+TimescaleDB almacena 90 días telemetría local con queries SQL sin dependencia internet. AWS/Azure requieren cloud para dashboards.

\textbf{(2) TCO 5 años (10,000 medidores):} ThingsBoard Cloud PE: \$60,000 (10K devices × \$0.10/mes × 60 meses). AWS Greengrass: \$240,000 (IoT Core msgs + Shadow sync + S3 storage). Azure IoT Edge: \$154,500 (IoT Hub + egress + Azure SQL). Ahorro ThingsBoard: \$180K (AWS) o \$94.5K (Azure).

\textbf{(3) Cero vendor lock-in:} Arquitectura 100\% portable con REST/MQTT APIs estándar, PostgreSQL export/import trivial. AWS/Azure lock-in profundo (Lambda functions, DynamoDB, S3 buckets). Costo switching estimado: \$50k-150k engineering.

\textbf{(4) Requisitos hardware accesibles:} Raspberry Pi 4 4GB suficiente (\$55) vs AWS/Azure requieren RPi 4 8GB o x86 (\$75-200). Ahorro hardware 10 Gateways: \$200-1,450.

\textbf{(5) Time-series optimization nativa:} TimescaleDB provee hypertables con particionamiento automático (chunks 7 días), compresión 10:1 columnar storage, continuous aggregates (latency <100 ms queries). AWS Timestream: \$15,000/mes para 10K devices (300× más caro).

\textbf{Trade-offs aceptados:} Límite 5,000 devices Community (upgrade a Pro \$2,500/mes sigue 50\% más barato que AWS/Azure). ML inference menos integrado (requiere custom TensorFlow Lite wrapper vs AWS SageMaker Edge managed).

\subsection{Análisis de Latencia End-to-End}

El claim "latencia 8±2 ms" requiere aclaración precisa del scope. La tabla~\ref{tab:latency-breakdown} desglosa latencia por componente.

\begin{table}[H]
\centering
\caption{Desglose latencia por componente: end-to-end completo vs procesamiento edge}
\label{tab:latency-breakdown}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|l|r|p{7cm}|}
\hline
\rowcolor{gray!20}
\textbf{Componente} & \textbf{Latencia} & \textbf{Justificación Técnica} \\
\hline
\multicolumn{3}{|c|}{\textbf{PATH COMPLETO END-TO-END (Medidor → ThingsBoard Cloud)}} \\
\hline
RS-485 @ 9600 bps (200 bytes DLMS) & 167 ms & $\frac{200 \times 10 \text{ bits}}{9600 \text{ bps}} = 0.208$ s (TX + ACK) \\
\hline
Procesamiento nodo ESP32C6 & 5 ms & Parse DLMS OBIS codes + encode CoAP (benchmark prototipo) \\
\hline
Thread multi-hop (3 saltos @ 250 kbps) & 15 ms & 5 ms/salto promedio (queuing + MAC CSMA/CA + retransmisiones 10\%) \\
\hline
OTBR forwarding (IPv6 routing) & 2 ms & Forwarding table lookup + encapsulación 6LoWPAN→IP \\
\hline
HaLow transmission @ 150 kbps (MCS0) & 11 ms & $\frac{200 \times 8}{150000} = 0.011$ s (frame TX + ACK) \\
\hline
\rowcolor{yellow!20}
\textbf{Subtotal hasta Gateway} & \textbf{200 ms} & \textbf{Dominado por RS-485 (83.5\% del tiempo)} \\
\hline
\multicolumn{3}{|c|}{\textbf{PROCESAMIENTO EDGE EN GATEWAY (HaLow RX → TimescaleDB Write)}} \\
\hline
Recepción HaLow + demodulación & 1 ms & Hardware NRC7292 con DMA \\
\hline
Parse MQTT payload (JSON 200B) & 2 ms & Raspberry Pi 4 @ 1.5 GHz (single-thread) \\
\hline
Rule Engine evaluation (TB Edge) & 3 ms & Evaluación reglas JavaScript locales (2-5 filtros típico) \\
\hline
TimescaleDB INSERT (local) & 2 ms & Write hypertable en PostgreSQL (SSD, índice BRIN) \\
\hline
\rowcolor{blue!20}
\textbf{Subtotal procesamiento edge} & \textbf{8 ms} & \textbf{Claim "8±2 ms" refiere a ESTE scope exclusivamente} \\
\hline
MQTT publish a TB Cloud (LTE) & 25 ms & Uplink LTE Cat-M1 (jitter ±10 ms según carrier) \\
\hline
Procesamiento nube + escritura BD & 15 ms & Load balancer + PostgreSQL cluster (3 nodos HA) \\
\hline
\rowcolor{green!20}
\textbf{TOTAL END-TO-END COMPLETO} & \textbf{248 ms} & \textbf{Cumple req. AMI IEC 62056 (<1 s)} \\
\hline
\end{tabular}%
}
\end{table}

\textbf{Aclaración crítica del scope de latencia:}

La métrica \textbf{"latencia 8±2 ms"} se refiere \textit{exclusivamente} al \textbf{procesamiento edge local en Gateway} (desde recepción frame HaLow hasta escritura TimescaleDB), \textbf{NO} a latencia E2E completa 248 ms. Esta distinción es crítica: (1) IEC 62056 especifica latencia máxima 1 segundo para lecturas periódicas AMI - 248 ms cumple con 75\% margen, (2) Comparación justa con arquitecturas baseline HTTP/REST (10-15 ms edge processing, pero sin analytics local), (3) Evitar confusión URLLC (AMI es eMBB, no requiere <1 ms).

\textbf{Validación experimental (piloto Q4 2024):} Latencia edge 8±2 ms medida en 30 medidores durante 3 meses. Metodología: timestamp payload MQTT (nodo) vs timestamp INSERT TimescaleDB (Gateway), sincronización NTP ±50 ms. Resultados: promedio 8.2 ms, P50=7.8 ms, P95=11.3 ms, P99=18.7 ms. Outliers 0.3\% mensajes >50 ms (GC Java en TB Edge).

\section{Nivel 4: Plataforma Central ThingsBoard Cloud}

El cuarto nivel implementa plataforma centralizada ThingsBoard Professional Edition 3.6 en AWS con cluster EC2 (3 nodos t3.xlarge: 4 vCPU, 16 GB RAM) detrás de Application Load Balancer. Base de datos: RDS PostgreSQL 14 Multi-AZ con réplica síncrona (RTO=60s, RPO=0). Almacenamiento time-series: Cassandra 4.0 cluster con 6 nodos i3.xlarge (RF=3, consistency QUORUM), capacity 50 TB comprimido para 5 años históricos 100K medidores.

\textbf{Message broker:} Amazon MSK (Managed Streaming for Apache Kafka) con 3 brokers kafka.m5.large multi-AZ, particionamiento por gateway ID (10 particiones/gateway), throughput sostenido 50,000 msg/s con latency P99 <100 ms. Consumer groups: (1) TB Rule Engine para eventos, (2) AWS Lambda para integración SCADA REST callbacks, (3) Kinesis Firehose para backup S3 + archival Glacier.

\textbf{Funcionalidades:} (1) Dashboards multi-tenant con RBAC granular (Admin, Tenant Admin, Customer User), (2) Reportes regulatorios automatizados CREG 015 (consumo facturado, pérdidas técnicas, índices SAIDI/SAIFI) exportados PDF/Excel via schedulers Quartz, (3) Integración bidireccional sistemas legacy: REST APIs para query históricos desde SCADA, webhooks para comandos DR desde DMS, (4) Analítica batch: Jobs Spark en EMR para detección fraude (Isolation Forest, ARIMA forecasting), (5) Notificaciones: Email (SES), SMS (SNS), push mobile (FCM/APNS) para alarmas críticas.

\textbf{SLA y disponibilidad:} Arquitectura diseñada para 99.95\% uptime anual (downtime máximo 4.38 h/año). Mecanismos HA: (1) ALB con health checks 30s, failover automático nodos unhealthy, (2) RDS Multi-AZ failover <60s, (3) Cassandra RF=3 tolerando fallo 1 nodo sin pérdida datos, (4) Backups automáticos: RDS daily snapshots (retención 30 días), Cassandra incremental backups 6h a S3 (retención 90 días), (5) Disaster Recovery plan con RTO=2h, RPO=6h (restore último backup Cassandra).

\section{Conclusiones del Capítulo}

La arquitectura jerárquica de 4 niveles presentada optimiza el balance costo-desempeño para despliegues AMI masivos mediante selección quirúrgica de tecnologías por nivel:

\textbf{Nivel 1 (Red de Campo):} Thread 1.4.0 mesh proporciona conectividad IPv6 nativa E2E eliminando gateways de traducción (latencia 40-60\% menor vs Zigbee), con nodos ESP32-C6 alimentados desde medidor Itron SL7000 (consumo 0.48W, DLMS/COSEM nativo \$85/unidad, 41\% ahorro CAPEX vs Landis+Gyr). Seguridad NIST CSF Tier 3 con 8 controles defense-in-depth (PAKE ECC P-256, WPA3-SAE, TPM 2.0, mTLS, encryption-at-rest).

\textbf{Nivel 2 (Distribución Híbrida):} Fibra GPON (2.5 Gbps, latencia 2-5 ms, alcance 20 km) para backhaul troncal + Wi-Fi HaLow (alcance 1 km sub-1 GHz) elimina cableado estructurado + LTE Cat-M1 (375 kbps uplink, latency 10-50 ms, \$8-12 módulo) para redundancia WAN dual-homing (uptime 99.99\% vs 99.9\% enlace único). Configuración eDRX+PSM reduce consumo LTE 98\% (60 mA → 1.03 mA). Operación multi-protocolo BLE (commissioning 2-5 min) + Thread (telemetría 24/7) con time-slicing autónomo overhead <5\%.

\textbf{Nivel 3 (Gateway Edge):} ThingsBoard Edge 3.6 en Raspberry Pi CM4 ejecuta Rule Engine JavaScript para detección anomalías (latencia procesamiento edge 8±2 ms validada piloto Q4 2024), agregación temporal TimescaleDB (continuous aggregates con compresión 10:1), y buffer offline 72h (capacidad 90 GB para 1000 medidores). Reducción 72\% tráfico WAN mediante eliminación redundancia + run-length encoding. TCO 5 años: \$60K ThingsBoard vs \$240K AWS Greengrass vs \$154.5K Azure IoT Edge (ahorro \$180K-\$94.5K). Cero vendor lock-in con APIs REST/MQTT estándar y PostgreSQL export/import trivial.

\textbf{Nivel 4 (Plataforma Cloud):} ThingsBoard PE en AWS con cluster EC2 Auto Scaling (3× t3.xlarge), RDS PostgreSQL Multi-AZ (RTO=60s, RPO=0), Cassandra 4.0 time-series (50 TB capacity, RF=3), y MSK Kafka (50K msg/s throughput, P99 latency <100 ms). Dashboards multi-tenant RBAC, reportes regulatorios CREG 015 automatizados, integración bidireccional SCADA/CIS REST APIs, analítica batch Spark EMR (detección fraude Isolation Forest). SLA 99.95\% uptime anual con DR plan RTO=2h RPO=6h.

\textbf{Métricas globales arquitectura:} Latencia E2E 248 ms cumple IEC 62056 (<1s) con 75\% margen. Disponibilidad sistema 99.62\% medida piloto 90 días excede objetivo 99.5\%. Consumo energético 2.47 W/medidor (53\% reducción vs baseline cloud-only 5.3 W/medidor), ahorro \$24,791 en 10 años para 1000 medidores + reducción 124 toneladas CO₂. Autonomía baterías respaldo 18-20h excede requisito IEC 62052 (8h mínimo). Escalabilidad validada: arquitectura soporta 10,000-100,000 medidores con escalamiento horizontal Gateway Edge + cloud Kafka/Cassandra.

La validación experimental presentada en el Capítulo~\ref{chap:validacion} (deployment piloto 30 medidores Q4 2024, 90 días operación) confirma viabilidad técnica de la arquitectura propuesta, con métricas de latencia, disponibilidad y consumo energético alineadas con modelos teóricos documentados en este capítulo. El análisis de costos TCO (Capítulo~\ref{chap:validacion}, sección análisis económico) demuestra payback 3.2 años mediante ahorro energético + reducción CAPEX hardware vs alternativas comerciales.
